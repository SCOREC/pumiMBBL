#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <float.h>
#include <time.h>
#include <string.h>
#include "pumi_routines.h"


double gauss_pts[40][40] = {
    {0,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.5773502691896257,-0.5773502691896257,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.7745966692414834,0,-0.7745966692414834,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.8611363115940525,0.3399810435848563,-0.3399810435848563,-0.8611363115940525,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9061798459386639,0.538469310105683,0,-0.538469310105683,-0.9061798459386639,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9324695142031521,0.6612093864662645,0.2386191860831969,-0.2386191860831969,-0.6612093864662645,-0.9324695142031521,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9491079123427584,0.7415311855993945,0.4058451513773971,0,-0.4058451513773971,-0.7415311855993945,-0.9491079123427584,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9602898564975364,0.7966664774136267,0.525532409916329,0.1834346424956498,-0.1834346424956498,-0.525532409916329,-0.7966664774136267,-0.9602898564975364,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9681602395076261,0.8360311073266358,0.6133714327005904,0.324253423403809,0,-0.324253423403809,-0.6133714327005904,-0.8360311073266358,-0.9681602395076261,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9739065285171717,0.8650633666889846,0.6794095682990244,0.4333953941292472,0.1488743389816312,-0.1488743389816312,-0.4333953941292472,-0.6794095682990244,-0.8650633666889846,-0.9739065285171717,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9782286581460569,0.8870625997680954,0.7301520055740494,0.5190961292068117,0.2695431559523449,0,-0.2695431559523449,-0.5190961292068117,-0.7301520055740494,-0.8870625997680954,-0.9782286581460569,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9815606342467191,0.9041172563704749,0.7699026741943047,0.5873179542866174,0.3678314989981801,0.1252334085114689,-0.1252334085114689,-0.3678314989981801,-0.5873179542866174,-0.7699026741943047,-0.9041172563704749,-0.9815606342467191,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9841830547185881,0.9175983992229779,0.8015780907333099,0.6423493394403401,0.4484927510364469,0.2304583159551348,0,-0.2304583159551348,-0.4484927510364469,-0.6423493394403401,-0.8015780907333099,-0.9175983992229779,-0.9841830547185881,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9862838086968124,0.9284348836635736,0.827201315069765,0.6872929048116854,0.5152486363581541,0.3191123689278897,0.1080549487073437,-0.1080549487073437,-0.3191123689278897,-0.5152486363581541,-0.6872929048116854,-0.827201315069765,-0.9284348836635736,-0.9862838086968124,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9879925180204854,0.937273392400706,0.8482065834104273,0.7244177313601701,0.5709721726085388,0.3941513470775634,0.2011940939974345,0,-0.2011940939974345,-0.3941513470775634,-0.5709721726085388,-0.7244177313601701,-0.8482065834104273,-0.937273392400706,-0.9879925180204854,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9894009349916499,0.9445750230732326,0.8656312023878319,0.7554044083550031,0.6178762444026438,0.4580167776572273,0.2816035507792589,0.09501250983763748,-0.09501250983763748,-0.2816035507792589,-0.4580167776572273,-0.6178762444026438,-0.7554044083550031,-0.8656312023878319,-0.9445750230732326,-0.9894009349916499,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9905754753144174,0.9506755217687677,0.8802391537269858,0.7815140038968014,0.6576711592166906,0.5126905370864769,0.3512317634538764,0.1784841814958478,0,-0.1784841814958478,-0.3512317634538764,-0.5126905370864769,-0.6576711592166906,-0.7815140038968014,-0.8802391537269858,-0.9506755217687677,-0.9905754753144174,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.991565168420931,0.9558239495713976,0.8926024664975558,0.8037049589725231,0.6916870430603532,0.5597708310739475,0.4117511614628426,0.2518862256915055,0.08477501304173529,-0.08477501304173529,-0.2518862256915055,-0.4117511614628426,-0.5597708310739475,-0.6916870430603532,-0.8037049589725231,-0.8926024664975558,-0.9558239495713976,-0.991565168420931,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9924068438435842,0.96020815213483,0.903155903614818,0.8227146565371428,0.7209661773352294,0.6005453046616811,0.464570741375961,0.3165640999636299,0.1603586456402253,0,-0.1603586456402253,-0.3165640999636299,-0.464570741375961,-0.6005453046616811,-0.7209661773352294,-0.8227146565371428,-0.903155903614818,-0.96020815213483,-0.9924068438435842,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9931285991850949,0.9639719272779139,0.9122344282513259,0.8391169718222189,0.7463319064601508,0.6360536807265151,0.5108670019508272,0.3737060887154195,0.2277858511416451,0.07652652113349734,-0.07652652113349734,-0.2277858511416451,-0.3737060887154195,-0.5108670019508272,-0.6360536807265151,-0.7463319064601508,-0.8391169718222189,-0.9122344282513259,-0.9639719272779139,-0.9931285991850949,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9937521706203896,0.9672268385663063,0.9200993341504009,0.8533633645833172,0.7684399634756778,0.6671388041974122,0.5516188358872198,0.4243421202074388,0.2880213168024011,0.1455618541608951,0,-0.1455618541608951,-0.2880213168024011,-0.4243421202074388,-0.5516188358872198,-0.6671388041974122,-0.7684399634756778,-0.8533633645833172,-0.9200993341504009,-0.9672268385663063,-0.9937521706203896,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9942945854823992,0.9700604978354286,0.9269567721871739,0.8658125777203001,0.7878168059792081,0.6944872631866827,0.5876404035069116,0.4693558379867571,0.3419358208920842,0.2078604266882213,0.06973927331972218,-0.06973927331972218,-0.2078604266882213,-0.3419358208920842,-0.4693558379867571,-0.5876404035069116,-0.6944872631866827,-0.7878168059792081,-0.8658125777203001,-0.9269567721871739,-0.9700604978354286,-0.9942945854823992,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9947693349975522,0.9725424712181152,0.9329710868260161,0.8767523582704415,0.80488840161884,0.7186613631319503,0.6196098757636461,0.5095014778460074,0.3903010380302909,0.264135680970345,0.1332568242984661,0,-0.1332568242984661,-0.264135680970345,-0.3903010380302909,-0.5095014778460074,-0.6196098757636461,-0.7186613631319503,-0.80488840161884,-0.8767523582704415,-0.9329710868260161,-0.9725424712181152,-0.9947693349975522,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9951872199970213,0.9747285559713095,0.9382745520027327,0.886415527004401,0.8200019859739029,0.7401241915785544,0.6480936519369755,0.5454214713888397,0.4337935076260451,0.3150426796961634,0.1911188674736163,0.06405689286260557,-0.06405689286260557,-0.1911188674736163,-0.3150426796961634,-0.4337935076260451,-0.5454214713888397,-0.6480936519369755,-0.7401241915785544,-0.8200019859739029,-0.886415527004401,-0.9382745520027327,-0.9747285559713095,-0.9951872199970213,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9955569697904982,0.9766639214595174,0.9429745712289743,0.8949919978782754,0.8334426287608339,0.7592592630373578,0.6735663684734683,0.5776629302412228,0.473002731445715,0.3611723058093879,0.2438668837209885,0.1228646926107104,0,-0.1228646926107104,-0.2438668837209885,-0.3611723058093879,-0.473002731445715,-0.5776629302412228,-0.6735663684734683,-0.7592592630373578,-0.8334426287608339,-0.8949919978782754,-0.9429745712289743,-0.9766639214595174,-0.9955569697904982,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.995885701145617,0.9783854459564711,0.9471590666617142,0.902637861984307,0.8454459427884982,0.7763859488206788,0.6964272604199573,0.606692293017618,0.5084407148245056,0.4030517551234864,0.2920048394859569,0.1768588203568902,0.05923009342931324,-0.05923009342931324,-0.1768588203568902,-0.2920048394859569,-0.4030517551234864,-0.5084407148245056,-0.606692293017618,-0.6964272604199573,-0.7763859488206788,-0.8454459427884982,-0.902637861984307,-0.9471590666617142,-0.9783854459564711,-0.995885701145617,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9961792628889885,0.9799234759615012,0.9509005578147049,0.9094823206774911,0.8562079080182945,0.7917716390705083,0.7170134737394238,0.6329079719464952,0.5405515645794567,0.4411482517500269,0.3359939036385089,0.2264593654395368,0.1139725856095299,0,-0.1139725856095299,-0.2264593654395368,-0.3359939036385089,-0.4411482517500269,-0.5405515645794567,-0.6329079719464952,-0.7170134737394238,-0.7917716390705083,-0.8562079080182945,-0.9094823206774911,-0.9509005578147049,-0.9799234759615012,-0.9961792628889885,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9964424975739545,0.9813031653708726,0.9542592806289383,0.9156330263921322,0.865892522574395,0.8056413709171792,0.7356108780136319,0.656651094038865,0.5697204718114017,0.4758742249551182,0.3762515160890787,0.2720616276351782,0.1645692821333808,0.05507928988403421,-0.05507928988403421,-0.1645692821333808,-0.2720616276351782,-0.3762515160890787,-0.4758742249551182,-0.5697204718114017,-0.656651094038865,-0.7356108780136319,-0.8056413709171792,-0.865892522574395,-0.9156330263921322,-0.9542592806289383,-0.9813031653708726,-0.9964424975739545,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9966794422605965,0.9825455052614132,0.9572855957780877,0.9211802329530587,0.8746378049201029,0.8181854876152523,0.7524628517344771,0.6782145376026865,0.5962817971382277,0.5075929551242275,0.4131528881740087,0.31403163786764,0.2113522861660011,0.1062782301326792,0,-0.1062782301326792,-0.2113522861660011,-0.31403163786764,-0.4131528881740087,-0.5075929551242275,-0.5962817971382277,-0.6782145376026865,-0.7524628517344771,-0.8181854876152523,-0.8746378049201029,-0.9211802329530587,-0.9572855957780877,-0.9825455052614132,-0.9966794422605965,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9968934840746495,0.9836681232797471,0.9600218649683074,0.9262000474292744,0.8825605357920527,0.8295657623827684,0.7677774321048263,0.697850494793316,0.6205261829892428,0.5366241481420198,0.4470337695380891,0.3527047255308782,0.2546369261678898,0.1538699136085835,0.05147184255531773,-0.05147184255531773,-0.1538699136085835,-0.2546369261678898,-0.3527047255308782,-0.4470337695380891,-0.5366241481420198,-0.6205261829892428,-0.697850494793316,-0.7677774321048263,-0.8295657623827684,-0.8825605357920527,-0.9262000474292744,-0.9600218649683074,-0.9836681232797471,-0.9968934840746495,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.997087481819477,0.9846859096651523,0.9625039250929497,0.9307569978966481,0.8897600299482711,0.8399203201462673,0.7817331484166248,0.7157767845868532,0.6427067229242605,0.5632491614071493,0.4781937820449025,0.3883859016082329,0.2947180699817016,0.1981211993355707,0.09955531215234154,0,-0.09955531215234154,-0.1981211993355707,-0.2947180699817016,-0.3883859016082329,-0.4781937820449025,-0.5632491614071493,-0.6427067229242605,-0.7157767845868532,-0.7817331484166248,-0.8399203201462673,-0.8897600299482711,-0.9307569978966481,-0.9625039250929497,-0.9846859096651523,-0.997087481819477,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9972638618494816,0.9856115115452684,0.9647622555875064,0.9349060759377397,0.896321155766052,0.8493676137325701,0.7944837959679423,0.7321821187402897,0.6630442669302152,0.5877157572407623,0.5068999089322292,0.4213512761306353,0.3318686022821277,0.239287362252137,0.1444719615827965,0.04830766568773837,-0.04830766568773837,-0.1444719615827965,-0.239287362252137,-0.3318686022821277,-0.4213512761306353,-0.5068999089322292,-0.5877157572407623,-0.6630442669302152,-0.7321821187402897,-0.7944837959679423,-0.8493676137325701,-0.896321155766052,-0.9349060759377397,-0.9647622555875064,-0.9856115115452684,-0.9972638618494816,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9974246942464551,0.9864557262306426,0.9668229096899927,0.9386943726111685,0.9023167677434336,0.858009652676504,0.8061623562741667,0.7472304964495622,0.6817319599697429,0.610242345836379,0.5333899047863477,0.4518500172724507,0.3663392577480733,0.2776090971524971,0.1864392988279915,0.09363106585473341,0,-0.09363106585473341,-0.1864392988279915,-0.2776090971524971,-0.3663392577480733,-0.4518500172724507,-0.5333899047863477,-0.610242345836379,-0.6817319599697429,-0.7472304964495622,-0.8061623562741667,-0.858009652676504,-0.9023167677434336,-0.9386943726111685,-0.9668229096899927,-0.9864557262306426,-0.9974246942464551,-999,-999,-999,-999,-999,-999,-999},
    {0.997571753790842,0.9872278164063095,0.9687082625333443,0.9421623974051072,0.9078096777183244,0.8659346383345645,0.8168842279009336,0.7610648766298729,0.6989391132162628,0.6310217270805285,0.5578755006697467,0.480106545190327,0.398359277758646,0.3133110813394633,0.2256666916164494,0.136152357259183,0.04550982195310249,-0.04550982195310249,-0.136152357259183,-0.2256666916164494,-0.3133110813394633,-0.398359277758646,-0.480106545190327,-0.5578755006697467,-0.6310217270805285,-0.6989391132162628,-0.7610648766298729,-0.8168842279009336,-0.8659346383345645,-0.9078096777183244,-0.9421623974051072,-0.9687082625333443,-0.9872278164063095,-0.997571753790842,-999,-999,-999,-999,-999,-999},
    {0.9977065690996003,0.9879357644438516,0.9704376160392298,0.9453451482078274,0.9128542613593176,0.8732191250252224,0.8267498990922255,0.7738102522869126,0.7148145015566287,0.6502243646658905,0.5805453447497646,0.5063227732414886,0.4281375415178142,0.3466015544308139,0.262352941209296,0.1760510611659896,0.08837134327565921,0,-0.08837134327565921,-0.1760510611659896,-0.262352941209296,-0.3466015544308139,-0.4281375415178142,-0.5063227732414886,-0.5805453447497646,-0.6502243646658905,-0.7148145015566287,-0.7738102522869126,-0.8267498990922255,-0.8732191250252224,-0.9128542613593176,-0.9453451482078274,-0.9704376160392298,-0.9879357644438516,-0.9977065690996003,-999,-999,-999,-999,-999},
    {0.9978304624840857,0.9885864789022123,0.9720276910496981,0.9482729843995075,0.9174977745156592,0.8799298008903973,0.8358471669924752,0.7855762301322065,0.7294891715935568,0.668001236585521,0.6015676581359806,0.5306802859262452,0.4558639444334203,0.3776725471196892,0.2966849953440283,0.2135008923168655,0.1287361038093848,0.04301819847370858,-0.04301819847370858,-0.1287361038093848,-0.2135008923168655,-0.2966849953440283,-0.3776725471196892,-0.4558639444334203,-0.5306802859262452,-0.6015676581359806,-0.668001236585521,-0.7294891715935568,-0.7855762301322065,-0.8358471669924752,-0.8799298008903973,-0.9174977745156592,-0.9482729843995075,-0.9720276910496981,-0.9885864789022123,-0.9978304624840857,-999,-999,-999,-999},
    {0.9979445824779136,0.9891859632143192,0.9734930300564857,0.9509723432620949,0.9217814374124638,0.8861249621554861,0.844252987340556,0.7964592005099023,0.7430788339819654,0.6844863091309592,0.6210926084089246,0.5533423918615816,0.4817108778032055,0.4067005093183261,0.328837429883707,0.2486677927913657,0.166753930239852,0.08367040895476996,0,-0.08367040895476996,-0.166753930239852,-0.2486677927913657,-0.328837429883707,-0.4067005093183261,-0.4817108778032055,-0.5533423918615816,-0.6210926084089246,-0.6844863091309592,-0.7430788339819654,-0.7964592005099023,-0.844252987340556,-0.8861249621554861,-0.9217814374124638,-0.9509723432620949,-0.9734930300564857,-0.9891859632143192,-0.9979445824779136,-999,-999,-999},
    {0.9980499305356876,0.9897394542663855,0.9748463285901536,0.9534663309335296,0.9257413320485846,0.8918557390046322,0.8520350219323622,0.8065441676053169,0.7556859037539707,0.6997986803791845,0.6392544158296816,0.5744560210478071,0.505834717927931,0.4338471694323764,0.358972440479435,0.2817088097901652,0.2025704538921167,0.1220840253378674,0.04078514790457821,-0.04078514790457821,-0.1220840253378674,-0.2025704538921167,-0.2817088097901652,-0.358972440479435,-0.4338471694323764,-0.505834717927931,-0.5744560210478071,-0.6392544158296816,-0.6997986803791845,-0.7556859037539707,-0.8065441676053169,-0.8520350219323622,-0.8918557390046322,-0.9257413320485846,-0.9534663309335296,-0.9748463285901536,-0.9897394542663855,-0.9980499305356876,-999,-999},
    {0.9981473830664329,0.9902515368546858,0.976098709333471,0.9557752123246521,0.9294091484867382,0.8971671192929929,0.8592529379999061,0.8159062974301432,0.7674012429310635,0.7140444358945346,0.6561732134320111,0.594153454957278,0.5283772686604373,0.459260512309136,0.3872401639715615,0.3127715592481859,0.2363255124618358,0.1583853399978378,0.0794438046087555,0,-0.0794438046087555,-0.1583853399978378,-0.2363255124618358,-0.3127715592481859,-0.3872401639715615,-0.459260512309136,-0.5283772686604373,-0.594153454957278,-0.6561732134320111,-0.7140444358945346,-0.7674012429310635,-0.8159062974301432,-0.8592529379999061,-0.8971671192929929,-0.9294091484867382,-0.9557752123246521,-0.976098709333471,-0.9902515368546858,-0.9981473830664329,-999},
    {0.9982377097105593,0.9907262386994571,0.9772599499837744,0.9579168192137917,0.9328128082786766,0.9020988069688745,0.8659595032122596,0.8246122308333117,0.7783056514265194,0.7273182551899271,0.6719566846141796,0.6125538896679803,0.5494671250951282,0.4830758016861787,0.4137792043716049,0.3419940908257585,0.2681521850072537,0.1926975807013711,0.1160840706752552,0.03877241750605087,-0.03877241750605087,-0.1160840706752552,-0.1926975807013711,-0.2681521850072537,-0.3419940908257585,-0.4137792043716049,-0.4830758016861787,-0.5494671250951282,-0.6125538896679803,-0.6719566846141796,-0.7273182551899271,-0.7783056514265194,-0.8246122308333117,-0.8659595032122596,-0.9020988069688745,-0.9328128082786766,-0.9579168192137917,-0.9772599499837744,-0.9907262386994571,-0.9982377097105593}
};

double gauss_wts[40][40] = {
    {2,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.9999999999999998,0.9999999999999998,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.5555555555555544,0.8888888888888888,0.5555555555555544,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.3478548451374544,0.652145154862546,0.652145154862546,0.3478548451374544,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.2369268850561891,0.4786286704993662,0.5688888888888889,0.4786286704993662,0.2369268850561891,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.1713244923791705,0.3607615730481387,0.467913934572691,0.467913934572691,0.3607615730481387,0.1713244923791705,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.1294849661688696,0.2797053914892768,0.381830050505119,0.4179591836734693,0.381830050505119,0.2797053914892768,0.1294849661688696,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.1012285362903768,0.2223810344533744,0.3137066458778873,0.3626837833783621,0.3626837833783621,0.3137066458778873,0.2223810344533744,0.1012285362903768,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.08127438836157463,0.1806481606948574,0.2606106964029355,0.3123470770400029,0.3302393550012598,0.3123470770400029,0.2606106964029355,0.1806481606948574,0.08127438836157463,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.06667134430868803,0.1494513491505806,0.2190863625159821,0.2692667193099962,0.2955242247147529,0.2955242247147529,0.2692667193099962,0.2190863625159821,0.1494513491505806,0.06667134430868803,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.05566856711617354,0.1255803694649041,0.186290210927734,0.2331937645919902,0.2628045445102467,0.2729250867779006,0.2628045445102467,0.2331937645919902,0.186290210927734,0.1255803694649041,0.05566856711617354,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.0471753363865118,0.1069393259953181,0.1600783285433461,0.2031674267230658,0.2334925365383548,0.2491470458134029,0.2491470458134029,0.2334925365383548,0.2031674267230658,0.1600783285433461,0.1069393259953181,0.0471753363865118,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.04048400476531581,0.09212149983772844,0.1388735102197871,0.1781459807619457,0.2078160475368883,0.2262831802628971,0.2325515532308739,0.2262831802628971,0.2078160475368883,0.1781459807619457,0.1388735102197871,0.09212149983772844,0.04048400476531581,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.035119460331752,0.08015808715976004,0.1215185706879032,0.1572031671581936,0.1855383974779378,0.2051984637212957,0.2152638534631577,0.2152638534631577,0.2051984637212957,0.1855383974779378,0.1572031671581936,0.1215185706879032,0.08015808715976004,0.035119460331752,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.03075324199611663,0.07036604748810814,0.1071592204671718,0.1395706779261542,0.1662692058169939,0.1861610000155621,0.1984314853271116,0.2025782419255613,0.1984314853271116,0.1861610000155621,0.1662692058169939,0.1395706779261542,0.1071592204671718,0.07036604748810814,0.03075324199611663,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.02715245941175406,0.06225352393864778,0.0951585116824929,0.1246289712555339,0.1495959888165768,0.1691565193950026,0.1826034150449236,0.1894506104550684,0.1894506104550684,0.1826034150449236,0.1691565193950026,0.1495959888165768,0.1246289712555339,0.0951585116824929,0.06225352393864778,0.02715245941175406,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.02414830286854793,0.05545952937398713,0.08503614831717916,0.1118838471934039,0.1351363684685254,0.1540457610768104,0.1680041021564499,0.1765627053669926,0.1794464703562065,0.1765627053669926,0.1680041021564499,0.1540457610768104,0.1351363684685254,0.1118838471934039,0.08503614831717916,0.05545952937398713,0.02414830286854793,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.02161601352648335,0.04971454889496928,0.0764257302548889,0.100942044106287,0.1225552067114783,0.1406429146706506,0.1546846751262654,0.1642764837458327,0.1691423829631435,0.1691423829631435,0.1642764837458327,0.1546846751262654,0.1406429146706506,0.1225552067114783,0.100942044106287,0.0764257302548889,0.04971454889496928,0.02161601352648335,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.01946178822972643,0.04481422676569941,0.06904454273764106,0.09149002162244992,0.111566645547334,0.1287539625393363,0.1426067021736067,0.1527660420658597,0.1589688433939544,0.1610544498487837,0.1589688433939544,0.1527660420658597,0.1426067021736067,0.1287539625393363,0.111566645547334,0.09149002162244992,0.06904454273764106,0.04481422676569941,0.01946178822972643,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.01761400713915167,0.04060142980038705,0.06267204833410904,0.08327674157670477,0.1019301198172405,0.1181945319615183,0.1316886384491766,0.1420961093183822,0.1491729864726038,0.152753387130726,0.152753387130726,0.1491729864726038,0.1420961093183822,0.1316886384491766,0.1181945319615183,0.1019301198172405,0.08327674157670477,0.06267204833410904,0.04060142980038705,0.01761400713915167,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.01601722825777477,0.0369537897708525,0.05713442542685725,0.07610011362837928,0.09344442345603382,0.1087972991671485,0.1218314160537285,0.1322689386333374,0.139887394791073,0.14452440398997,0.1460811336496904,0.14452440398997,0.139887394791073,0.1322689386333374,0.1218314160537285,0.1087972991671485,0.09344442345603382,0.07610011362837928,0.05713442542685725,0.0369537897708525,0.01601722825777477,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.01462799529827245,0.03377490158481398,0.05229333515268329,0.06979646842452047,0.08594160621706781,0.100414144442881,0.1129322960805392,0.1232523768105123,0.1311735047870624,0.1365414983460151,0.139251872855632,0.139251872855632,0.1365414983460151,0.1311735047870624,0.1232523768105123,0.1129322960805392,0.100414144442881,0.08594160621706781,0.06979646842452047,0.05229333515268329,0.03377490158481398,0.01462799529827245,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.01341185948714168,0.03098800585697934,0.0480376717310847,0.0642324214085257,0.079281411776719,0.09291576606003502,0.1048920914645415,0.1149966402224115,0.1230490843067294,0.1289057221880821,0.1324620394046966,0.1336545721861062,0.1324620394046966,0.1289057221880821,0.1230490843067294,0.1149966402224115,0.1048920914645415,0.09291576606003502,0.079281411776719,0.0642324214085257,0.0480376717310847,0.03098800585697934,0.01341185948714168,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.01234122979998734,0.02853138862893319,0.04427743881741955,0.05929858491543662,0.07334648141108011,0.0861901615319533,0.09761865210411381,0.1074442701159656,0.1155056680537256,0.1216704729278035,0.1258374563468283,0.1279381953467522,0.1279381953467522,0.1258374563468283,0.1216704729278035,0.1155056680537256,0.1074442701159656,0.09761865210411381,0.0861901615319533,0.07334648141108011,0.05929858491543662,0.04427743881741955,0.02853138862893319,0.01234122979998734,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.01139379850102617,0.02635498661503189,0.04093915670130604,0.05490469597583507,0.06803833381235669,0.08014070033500097,0.0910282619829637,0.1005359490670506,0.1085196244742636,0.1148582591457116,0.1194557635357848,0.1222424429903101,0.1231760537267155,0.1222424429903101,0.1194557635357848,0.1148582591457116,0.1085196244742636,0.1005359490670506,0.0910282619829637,0.08014070033500097,0.06803833381235669,0.05490469597583507,0.04093915670130604,0.02635498661503189,0.01139379850102617,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.01055137261734294,0.0244178510926316,0.03796238329436269,0.05097582529714779,0.06327404632957494,0.07468414976565983,0.08504589431348522,0.09421380035591413,0.1020591610944254,0.1084718405285766,0.1133618165463198,0.1166604434852967,0.1183214152792623,0.1183214152792623,0.1166604434852967,0.1133618165463198,0.1084718405285766,0.1020591610944254,0.09421380035591413,0.08504589431348522,0.07468414976565983,0.06327404632957494,0.05097582529714779,0.03796238329436269,0.0244178510926316,0.01055137261734294,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.009798996051294803,0.02268623159618045,0.03529705375741968,0.04744941252061497,0.05898353685983342,0.06974882376624547,0.07960486777305764,0.08842315854375699,0.09608872737002855,0.1025016378177458,0.1075782857885331,0.1112524883568451,0.1134763461089651,0.114220867378957,0.1134763461089651,0.1112524883568451,0.1075782857885331,0.1025016378177458,0.09608872737002855,0.08842315854375699,0.07960486777305764,0.06974882376624547,0.05898353685983342,0.04744941252061497,0.03529705375741968,0.02268623159618045,0.009798996051294803,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.009124282593094619,0.02113211259277096,0.03290142778230431,0.04427293475900416,0.05510734567571679,0.06527292396699962,0.07464621423456884,0.08311341722890114,0.09057174439303278,0.09693065799792992,0.1021129675780608,0.1060557659228464,0.1087111922582941,0.1100470130164752,0.1100470130164752,0.1087111922582941,0.1060557659228464,0.1021129675780608,0.09693065799792992,0.09057174439303278,0.08311341722890114,0.07464621423456884,0.06527292396699962,0.05510734567571679,0.04427293475900416,0.03290142778230431,0.02113211259277096,0.009124282593094619,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.008516903878746289,0.01973208505612247,0.03074049220209352,0.04140206251868279,0.05159482690249781,0.06120309065707915,0.0701179332550512,0.07823832713576384,0.08547225736617245,0.09173775713925884,0.0969638340944086,0.101091273759915,0.1040733100777294,0.105876155097321,0.1064793817183143,0.105876155097321,0.1040733100777294,0.101091273759915,0.0969638340944086,0.09173775713925884,0.08547225736617245,0.07823832713576384,0.0701179332550512,0.06120309065707915,0.05159482690249781,0.04140206251868279,0.03074049220209352,0.01973208505612247,0.008516903878746289,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.007968192496166645,0.01846646831109098,0.02878470788332339,0.03879919256962702,0.0484026728305941,0.05749315621761895,0.0659742298821805,0.07375597473770511,0.08075589522942012,0.08689978720108302,0.09212252223778615,0.09636873717464436,0.09959342058679521,0.1017623897484055,0.1028526528935589,0.1028526528935589,0.1017623897484055,0.09959342058679521,0.09636873717464436,0.09212252223778615,0.08689978720108302,0.08075589522942012,0.07375597473770511,0.0659742298821805,0.05749315621761895,0.0484026728305941,0.03879919256962702,0.02878470788332339,0.01846646831109098,0.007968192496166645,-999,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.007470831579248863,0.01731862079031061,0.02700901918497936,0.03643227391238541,0.04549370752720103,0.05410308242491677,0.06217478656102842,0.06962858323541035,0.07639038659877666,0.08239299176158922,0.08757674060847796,0.09189011389364153,0.09529024291231947,0.09774333538632875,0.09922501122667228,0.09972054479342643,0.09922501122667228,0.09774333538632875,0.09529024291231947,0.09189011389364153,0.08757674060847796,0.08239299176158922,0.07639038659877666,0.06962858323541035,0.06217478656102842,0.05410308242491677,0.04549370752720103,0.03643227391238541,0.02700901918497936,0.01731862079031061,0.007470831579248863,-999,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.007018610009470139,0.01627439473090571,0.02539206530926214,0.0342738629130214,0.04283589802222656,0.05099805926237615,0.05868409347853557,0.06582222277636193,0.07234579410884863,0.07819389578707045,0.08331192422694673,0.08765209300440376,0.0911738786957639,0.09384439908080446,0.09563872007927487,0.09654008851472785,0.09654008851472785,0.09563872007927487,0.09384439908080446,0.0911738786957639,0.08765209300440376,0.08331192422694673,0.07819389578707045,0.07234579410884863,0.06582222277636193,0.05868409347853557,0.05099805926237615,0.04283589802222656,0.0342738629130214,0.02539206530926214,0.01627439473090571,0.007018610009470139,-999,-999,-999,-999,-999,-999,-999,-999},
    {0.006606227847587485,0.0153217015129347,0.02391554810174945,0.03230035863232887,0.04040154133166962,0.04814774281871168,0.0554708466316635,0.06230648253031741,0.06859457281865683,0.07427985484395411,0.07931236479488674,0.08364787606703879,0.0872482876188443,0.09008195866063855,0.09212398664331685,0.09335642606559606,0.09376844616020999,0.09335642606559606,0.09212398664331685,0.09008195866063855,0.0872482876188443,0.08364787606703879,0.07931236479488674,0.07427985484395411,0.06859457281865683,0.06230648253031741,0.0554708466316635,0.04814774281871168,0.04040154133166962,0.03230035863232887,0.02391554810174945,0.0153217015129347,0.006606227847587485,-999,-999,-999,-999,-999,-999,-999},
    {0.006229140555908527,0.01445016274859503,0.02256372198549493,0.03049138063844614,0.03816659379638743,0.04552561152335326,0.05250741457267811,0.05905413582752449,0.06511152155407629,0.07062937581425567,0.07556197466003195,0.07986844433977194,0.08351309969984558,0.08646573974703581,0.08870189783569379,0.09020304437064075,0.09095674033025986,0.09095674033025986,0.09020304437064075,0.08870189783569379,0.08646573974703581,0.08351309969984558,0.07986844433977194,0.07556197466003195,0.07062937581425567,0.06511152155407629,0.05905413582752449,0.05250741457267811,0.04552561152335326,0.03816659379638743,0.03049138063844614,0.02256372198549493,0.01445016274859503,0.006229140555908527,-999,-999,-999,-999,-999,-999},
    {0.005883433420443168,0.01365082834836154,0.02132297991148354,0.02882926010889425,0.03611011586346346,0.04310842232617012,0.04976937040135343,0.05604081621237026,0.0618736719660801,0.0672222852690868,0.07204479477256009,0.076303457155442,0.07996494224232426,0.08300059372885665,0.0853866533920991,0.08710444699718348,0.08814053043027549,0.08848679490710427,0.08814053043027549,0.08710444699718348,0.0853866533920991,0.08300059372885665,0.07996494224232426,0.076303457155442,0.07204479477256009,0.0672222852690868,0.0618736719660801,0.05604081621237026,0.04976937040135343,0.04310842232617012,0.03611011586346346,0.02882926010889425,0.02132297991148354,0.01365082834836154,0.005883433420443168,-999,-999,-999,-999,-999},
    {0.005565719664245068,0.01291594728406522,0.02018151529773513,0.02729862149856854,0.03421381077030707,0.04087575092364476,0.04723508349026585,0.05324471397775972,0.0588601442453248,0.06403979735501547,0.06874532383573639,0.07294188500565307,0.07659841064587077,0.07968782891207167,0.08218726670433972,0.08407821897966186,0.08534668573933869,0.08598327567039468,0.08598327567039468,0.08534668573933869,0.08407821897966186,0.08218726670433972,0.07968782891207167,0.07659841064587077,0.07294188500565307,0.06874532383573639,0.06403979735501547,0.0588601442453248,0.05324471397775972,0.04723508349026585,0.04087575092364476,0.03421381077030707,0.02729862149856854,0.02018151529773513,0.01291594728406522,0.005565719664245068,-999,-999,-999,-999},
    {0.005273057279497987,0.0122387801003073,0.01912904448908366,0.02588603699055874,0.03246163984752142,0.03880960250193449,0.04488536466243712,0.05064629765482458,0.05605198799827485,0.06106451652322591,0.065648722872751,0.0697724515557003,0.07340677724848814,0.07652620757052916,0.07910886183752938,0.08113662450846504,0.08259527223643719,0.08347457362586289,0.08376836099313889,0.08347457362586289,0.08259527223643719,0.08113662450846504,0.07910886183752938,0.07652620757052916,0.07340677724848814,0.0697724515557003,0.065648722872751,0.06106451652322591,0.05605198799827485,0.05064629765482458,0.04488536466243712,0.03880960250193449,0.03246163984752142,0.02588603699055874,0.01912904448908366,0.0122387801003073,0.005273057279497987,-999,-999,-999},
    {0.005002880749639456,0.01161344471646843,0.01815657770961305,0.02457973973823229,0.03083950054517494,0.03689408159402466,0.04270315850467435,0.04822806186075861,0.05343201991033238,0.0582803991469971,0.06274093339213305,0.06678393797914044,0.07038250706689904,0.07351269258474345,0.07615366354844642,0.07828784465821101,0.07990103324352786,0.08098249377059706,0.08152502928038578,0.08152502928038578,0.08098249377059706,0.07990103324352786,0.07828784465821101,0.07615366354844642,0.07351269258474345,0.07038250706689904,0.06678393797914044,0.06274093339213305,0.0582803991469971,0.05343201991033238,0.04822806186075861,0.04270315850467435,0.03689408159402466,0.03083950054517494,0.02457973973823229,0.01815657770961305,0.01161344471646843,0.005002880749639456,-999,-999},
    {0.004752944691635117,0.0110347889391644,0.01725622909372479,0.02336938483217808,0.02933495598390325,0.03511511149813133,0.04067327684793375,0.04597430110891655,0.05098466529212928,0.05567269034091627,0.06000873608859611,0.06396538813868237,0.06751763096623124,0.07064300597060878,0.07332175341426869,0.07553693732283598,0.07727455254468205,0.07852361328737112,0.07927622256836855,0.07952762213944282,0.07927622256836855,0.07852361328737112,0.07727455254468205,0.07553693732283598,0.07332175341426869,0.07064300597060878,0.06751763096623124,0.06396538813868237,0.06000873608859611,0.05567269034091627,0.05098466529212928,0.04597430110891655,0.04067327684793375,0.03511511149813133,0.02933495598390325,0.02336938483217808,0.01725622909372479,0.0110347889391644,0.004752944691635117,-999},
    {0.004521277098533582,0.01049828453115258,0.01642105838190788,0.02224584919416698,0.02793700698002333,0.03346019528254786,0.03878216797447197,0.04387090818567334,0.0486958076350722,0.05322784698393677,0.05743976909939155,0.06130624249292889,0.06480401345660106,0.06791204581523393,0.07061164739128682,0.0728865823958041,0.07472316905796816,0.0761103619006263,0.07703981816424797,0.07750594797842483,0.07750594797842483,0.07703981816424797,0.0761103619006263,0.07472316905796816,0.0728865823958041,0.07061164739128682,0.06791204581523393,0.06480401345660106,0.06130624249292889,0.05743976909939155,0.05322784698393677,0.0486958076350722,0.04387090818567334,0.03878216797447197,0.03346019528254786,0.02793700698002333,0.02224584919416698,0.01642105838190788,0.01049828453115258,0.004521277098533582}
};

/*
* \brief Call appropriate subroutine (based on the dimension of the problem) to compute the total number of elements in the mesh
* \param *pumi_mesh pointer object to struct pumi_mesh
*/
int pumi_total_elements(pumi_mesh_t *pumi_mesh)
{
  int Nel_total;
  if (pumi_mesh->ndim == 1){
    Nel_total = pumi_total_elements_1D(pumi_mesh);
  }
  else {
    Nel_total = pumi_total_elements_2D(pumi_mesh);
  }
  return Nel_total;
}

/*
* \brief Computes and returns the total number of elements in the mesh for 1D domain
* \param *pumi_mesh pointer object to struct pumi_mesh
*/
int pumi_total_elements_1D(pumi_mesh_t *pumi_mesh)
{
  int Nel_total = pumi_mesh->pumi_Nel_total_x1;
  return Nel_total;
}

/*
* \brief Computes and returns the total number of elements in the mesh for 1D domain
* \param *pumi_mesh pointer object to struct pumi_mesh
*/
int pumi_total_elements_2D(pumi_mesh_t *pumi_mesh)
{
  int Nel_total = pumi_mesh->pumi_Nel_total_2D;
  return Nel_total;
}

/*
* \brief Call appropriate subroutine (based on the dimension of the problem) to compute the total number of elements in the mesh
* \param *pumi_mesh pointer object to struct pumi_mesh
*/
int pumi_total_nodes(pumi_mesh_t *pumi_mesh)
{
  int Nel_total;
  if (pumi_mesh->ndim == 1){
    Nel_total = pumi_total_nodes_1D(pumi_mesh);
  }
  else {
    Nel_total = pumi_total_nodes_2D(pumi_mesh);
  }
  return Nel_total;
}

/*
* \brief Computes and returns the total number of elements in the mesh for 1D domain
* \param *pumi_mesh pointer object to struct pumi_mesh
*/
int pumi_total_nodes_1D(pumi_mesh_t *pumi_mesh)
{
  int Nnp_total = pumi_mesh->pumi_Nnp_total_x1;
  return Nnp_total;
}

/*
* \brief Computes and returns the total number of elements in the mesh for 1D domain
* \param *pumi_mesh pointer object to struct pumi_mesh
*/
int pumi_total_nodes_2D(pumi_mesh_t *pumi_mesh)
{
  int Nnp_total = pumi_mesh->pumi_Nnp_total_2D;
  return Nnp_total;
}

/*
* \brief Computes and returns the total number of elements in a submesh block for 1D domain
* \param *pumi_mesh pointer object to struct pumi_mesh
* \param ID of the submesh
*/
int pumi_submesh_total_elements_1D(pumi_mesh_t *pumi_mesh, int isubmesh)
{
  return ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->submesh_Nel;
}

/*
* \brief Computes and returns the coordinate of the left endpoint of the mesh
* \param *pumi_mesh pointer object to struct pumi_mesh
*/
double pumi_global_x1_min(pumi_mesh_t *pumi_mesh)
{
  double global_x1_left = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + 0)->coord_min;
  return global_x1_left;
}

/*
* \brief Computes and returns the coordinate of the right endpoint of the mesh
* \param *pumi_mesh pointer object to struct pumi_mesh
*/
double pumi_global_x1_max(pumi_mesh_t *pumi_mesh)
{
  double global_x1_right = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + (pumi_mesh->nsubmeshes_x1 - 1))->coord_max;
  return global_x1_right;
}

/*
* \brief Computes and returns the coordinate of the left endpoint of the mesh
* \param *pumi_mesh pointer object to struct pumi_mesh
*/
double pumi_global_x2_min(pumi_mesh_t *pumi_mesh)
{
  double global_x1_bottom = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + 0)->coord_min;
  return global_x1_bottom;
}

/*
* \brief Computes and returns the coordinate of the right endpoint of the mesh
* \param *pumi_mesh pointer object to struct pumi_mesh
*/
double pumi_global_x2_max(pumi_mesh_t *pumi_mesh)
{
  double global_x1_top = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + (pumi_mesh->nsubmeshes_x2 - 1))->coord_max;
  return global_x1_top;
}

/*
* \brief Computes and returns the covolume for a given node in the mesh
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] node number
*/
double pumi_return_covolume_1D(pumi_mesh_t* pumi_mesh, int *inode){
  double covolume;
  if (inode[0] == 0){
    covolume = pumi_return_elemsize(pumi_mesh, inode[0], pumi_elem_on_right_offset, pumi_x1)/2.0;
  }
  else if (inode[0] == pumi_mesh->pumi_Nel_total_x1){
    covolume = pumi_return_elemsize(pumi_mesh, inode[0], pumi_elem_on_left_offset, pumi_x1)/2.0;
  }
  else if (inode[0] > 0 && inode[0] < pumi_mesh->pumi_Nel_total_x1){
    covolume = pumi_return_elemsize(pumi_mesh, inode[0], pumi_elem_on_left_offset, pumi_x1)/2.0 + pumi_return_elemsize(pumi_mesh, inode[0], pumi_elem_on_right_offset, pumi_x1)/2.0;
  }
  else{
    printf("\tInvalid node number for covolume\n");
    exit(0);
  }
  return covolume;
}

double pumi_return_covolume_2D(pumi_mesh_t* pumi_mesh, int *inode){
    int inp_x1, inp_x2;
    inp_x1 = inode[0];
    inp_x2 = inode[1];
    double dx1_left, dx1_right, dx2_bottom, dx2_top;
    if (inp_x1 == 0){
      dx1_left = 0.0;
      dx1_right = pumi_return_elemsize(pumi_mesh, inp_x1, pumi_elem_on_right_offset, pumi_x1);
    }
    else if (inp_x1 == pumi_mesh->pumi_Nel_total_x1){
      dx1_left = pumi_return_elemsize(pumi_mesh, inp_x1, pumi_elem_on_left_offset, pumi_x1);
      dx1_right = 0.0;
    }
    else if (inp_x1 > 0 && inp_x1 < pumi_mesh->pumi_Nel_total_x1){
      dx1_left = pumi_return_elemsize(pumi_mesh, inp_x1, pumi_elem_on_left_offset, pumi_x1);
      dx1_right = pumi_return_elemsize(pumi_mesh, inp_x1, pumi_elem_on_right_offset, pumi_x1);
    }
    else{
      printf("\tInvalid x1 - node number for covolume\n");
      exit(0);
    }

    if (inp_x2 == 0){
      dx2_bottom = 0.0;
      dx2_top = pumi_return_elemsize(pumi_mesh, inp_x2, pumi_elem_on_top_offset, pumi_x2);
    }
    else if (inp_x2 == pumi_mesh->pumi_Nel_total_x2){
      dx2_bottom = pumi_return_elemsize(pumi_mesh, inp_x2, pumi_elem_on_bottom_offset, pumi_x2);
      dx2_top = 0.0;
    }
    else if (inp_x2 > 0 && inp_x2 < pumi_mesh->pumi_Nel_total_x2){
      dx2_bottom = pumi_return_elemsize(pumi_mesh, inp_x2, pumi_elem_on_bottom_offset, pumi_x2);
      dx2_top = pumi_return_elemsize(pumi_mesh, inp_x2, pumi_elem_on_top_offset, pumi_x2);
    }
    else{
      printf("\tInvalid x2 - node number for covolume\n");
      exit(0);
    }

    double covolume = (dx1_left*dx2_bottom + dx1_right*dx2_bottom +  dx1_left*dx2_top + dx1_right*dx2_top)/4.0;
    return covolume;

}
/*
* \brief Call appropriate subroutine (based on the dimension of the problem) to compute BL element sizes
* \param *pumi_mesh pointer object to struct pumi_mesh
*/
void pumi_BL_elemsize_ON(pumi_mesh_t *pumi_mesh){
  if (pumi_mesh->ndim == 1){
    pumi_BL_elemsize_ON_1D(pumi_mesh);
  }
  else {
    pumi_BL_elemsize_ON_2D(pumi_mesh);
    //printf("Multi dimension pumi mesh not implemented -- Terminating\n");
    //exit(0);
  }
}

/*
* \brief Computes and stores BL element size in submesh stuct member
* \param *pumi_mesh pointer object to struct pumi_mesh
*/
void pumi_BL_elemsize_ON_1D(pumi_mesh_t *pumi_mesh){
    int isubmesh;
  for (isubmesh=0; isubmesh<pumi_mesh->nsubmeshes_x1; isubmesh++){
    if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->pumi_flag & leftBL){
      int left_Nel = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->submesh_Nel;
      ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize = (double*) malloc(left_Nel*sizeof(double));
      ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords = (double*) malloc((left_Nel+1)*sizeof(double));
      *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + 0) = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->t0;
      *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + 0) = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_min;
      *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + 1) = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_min+((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->t0;
      int iCell;
      for (iCell=1; iCell<left_Nel-1; iCell++){
        *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + iCell) = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + (iCell-1))*((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r;
        *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + (iCell+1)) = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + (iCell)) + *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + iCell);
      }
      iCell = left_Nel-1;
      *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + iCell) = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + (iCell-1))*((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r;
      *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + (iCell+1)) = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_max;
    }
    if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->pumi_flag & rightBL){
      int right_Nel = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->submesh_Nel;
      ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize = (double*) malloc(right_Nel*sizeof(double));
      ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords = (double*) malloc((right_Nel+1)*sizeof(double));
      *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + 0) = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->t0*pow(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r,((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->submesh_Nel-1);
      *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + 0) = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_min;
      *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + 1) = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + 0) + *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + 0);
      int iCell;
      for (iCell=1; iCell<right_Nel-1; iCell++){
        *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + iCell) = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + (iCell-1))/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r;
        *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + (iCell+1)) = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + (iCell)) + *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + iCell);
      }
      iCell = right_Nel-1;
      *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + iCell) = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + (iCell-1))/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r;
      *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + (iCell+1)) = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_max;
    }
  }
}

/*
* \brief Computes and stores BL element size in submesh stuct member
* \param *pumi_mesh pointer object to struct pumi_mesh
*/
void pumi_BL_elemsize_ON_2D(pumi_mesh_t *pumi_mesh){
    int isubmesh, jsubmesh;
    for (isubmesh=0; isubmesh<pumi_mesh->nsubmeshes_x1; isubmesh++){
        if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->pumi_flag & leftBL){
            int left_Nel = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->submesh_Nel;
            ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize = (double*) malloc(left_Nel*sizeof(double));
            ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords = (double*) malloc((left_Nel+1)*sizeof(double));
            *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + 0) = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->t0;
            *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + 0) = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_min;
            *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + 1) = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_min+((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->t0;
            int iCell;
            for (iCell=1; iCell<left_Nel-1; iCell++){
                *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + iCell) = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + (iCell-1))*((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r;
                *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + (iCell+1)) = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + (iCell)) + *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + iCell);
            }
            iCell = left_Nel-1;
            *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + iCell) = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + (iCell-1))*((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r;
            *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + (iCell+1)) = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_max;
        }
        if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->pumi_flag & rightBL){
            int right_Nel = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->submesh_Nel;
            ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize = (double*) malloc(right_Nel*sizeof(double));
            ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords = (double*) malloc((right_Nel+1)*sizeof(double));
            *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + 0) = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->t0*pow(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r,((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->submesh_Nel-1);
            *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + 0) = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_min;
            *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + 1) = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + 0) + *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + 0);
            int iCell;
            for (iCell=1; iCell<right_Nel-1; iCell++){
                *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + iCell) = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + (iCell-1))/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r;
                *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + (iCell+1)) = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + (iCell)) + *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + iCell);
            }
            iCell = right_Nel-1;
            *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + iCell) = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + (iCell-1))/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r;
            *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + (iCell+1)) = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_max;
        }
    }

    for (jsubmesh=0; jsubmesh<pumi_mesh->nsubmeshes_x2; jsubmesh++){
        if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->pumi_flag & bottomBL){
            int bottom_Nel = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->submesh_Nel;
            ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_elemsize = (double*) malloc(bottom_Nel*sizeof(double));
            ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_coords = (double*) malloc((bottom_Nel+1)*sizeof(double));
            *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_elemsize + 0) = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->t0;
            *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_coords + 0) = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->coord_min;
            *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_coords + 1) = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->coord_min+((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->t0;
            int iCell;
            for (iCell=1; iCell<bottom_Nel-1; iCell++){
                *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_elemsize + iCell) = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_elemsize + (iCell-1))*((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->r;
                *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_coords + (iCell+1)) = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_coords + (iCell)) + *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_elemsize + iCell);
            }
            iCell = bottom_Nel-1;
            *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_elemsize + iCell) = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_elemsize + (iCell-1))*((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->r;
            *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_coords + (iCell+1)) = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->coord_max;
        }
        if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->pumi_flag & topBL){
            int top_Nel = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->submesh_Nel;
            ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_elemsize = (double*) malloc(top_Nel*sizeof(double));
            ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_coords = (double*) malloc((top_Nel+1)*sizeof(double));
            *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_elemsize + 0) = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->t0*pow(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->r,((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->submesh_Nel-1);
            *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_coords + 0) = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->coord_min;
            *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_coords + 1) = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_coords + 0) + *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_elemsize + 0);
            int iCell;
            for (iCell=1; iCell<top_Nel-1; iCell++){
                *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_elemsize + iCell) = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_elemsize + (iCell-1))/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->r;
                *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_coords + (iCell+1)) = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_coords + (iCell)) + *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_elemsize + iCell);
            }
            iCell = top_Nel-1;
            *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_elemsize + iCell) = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_elemsize + (iCell-1))/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->r;
            *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_coords + (iCell+1)) = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->coord_max;
        }
    }
}

/*
* \brief Call appropriate subroutine (based on the dimension of the problem) to free allocated memory to compute BL elem sizes
* \param *pumi_mesh pointer object to struct pumi_mesh
*/
void pumi_BL_elemsize_OFF(pumi_mesh_t *pumi_mesh){
  if (pumi_mesh->ndim == 1){
    pumi_BL_elemsize_OFF_1D(pumi_mesh);
  }
  else {
    pumi_BL_elemsize_OFF_2D(pumi_mesh);
    //printf("Multi dimension pumi mesh not implemented -- Terminating\n");
    //exit(0);
  }
}

/*
* \brief Frees allocated memory to compute 1D BL elem sizes for all submeshes
* \param *pumi_mesh pointer object to struct pumi_mesh
*/
void pumi_BL_elemsize_OFF_1D(pumi_mesh_t *pumi_mesh){
    pumi_mesh->BL_elem_coords_cache_flag = 0;
    int isubmesh;
  for (isubmesh=0; isubmesh<pumi_mesh->nsubmeshes_x1; isubmesh++){
    if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->pumi_flag & leftBL){
      free(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize);
      free(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords);
    }
    if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->pumi_flag & rightBL){
      free(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize);
      free(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords);
    }
  }
}

/*
* \brief Frees allocated memory to compute 1D BL elem sizes for all submeshes
* \param *pumi_mesh pointer object to struct pumi_mesh
*/
void pumi_BL_elemsize_OFF_2D(pumi_mesh_t *pumi_mesh){
    pumi_mesh->BL_elem_coords_cache_flag = 0;
    int isubmesh, jsubmesh;
    for (isubmesh=0; isubmesh<pumi_mesh->nsubmeshes_x1; isubmesh++){
        if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->pumi_flag & leftBL){
            free(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize);
            free(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords);
        }
        if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->pumi_flag & rightBL){
            free(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize);
            free(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords);
        }
    }

    for (jsubmesh=0; jsubmesh<pumi_mesh->nsubmeshes_x2; jsubmesh++){
        if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->pumi_flag & bottomBL){
            free(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_elemsize);
            free(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_coords);
        }
        if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->pumi_flag & topBL){
            free(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_elemsize);
            free(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->BL_coords);
        }
    }
}


double pumi_return_gradingratio(pumi_mesh_t *pumi_mesh, int node, int dir){
    pumi_submesh_t *submeshes;
    int Nel_total, nsubmeshes;
    if (dir == pumi_x1){
        submeshes = (pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1;
        Nel_total = pumi_mesh->pumi_Nel_total_x1;
        nsubmeshes = pumi_mesh->nsubmeshes_x1;
    }
    else{
        submeshes = (pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2;
        Nel_total = pumi_mesh->pumi_Nel_total_x2;
        nsubmeshes = pumi_mesh->nsubmeshes_x2;
    }

    if (node == 0 || node == Nel_total){
        printf("Grading ratio not defined for the first and last node of the domain -- Terminating \n");
        exit(0);
    }
    else{
        int isubmesh;
        for (isubmesh=0; isubmesh<nsubmeshes; isubmesh++){
            int submesh_min_node = (submeshes + isubmesh)->Nel_cumulative;
            int submesh_max_node = submesh_min_node + (submeshes + isubmesh)->submesh_Nel;
            if (node > submesh_min_node && node < submesh_max_node){
                if ((submeshes + isubmesh)->pumi_flag & rightBL){
                    return (1.0/(submeshes + isubmesh)->r);
                }
                else{
                    return (submeshes + isubmesh)->r;
                }
            }
            else if (node == (submeshes + isubmesh)->Nel_cumulative){
                double min_elem_size;
                double max_elem_size;
                // On min of the node
                if ((submeshes + isubmesh-1)->pumi_flag & rightBL){
                    min_elem_size = (submeshes + isubmesh-1)->t0;
                }
                if ((submeshes + isubmesh-1)->pumi_flag & uniform){
                    min_elem_size = (submeshes + isubmesh-1)->t0;
                }
                if ((submeshes + isubmesh-1)->pumi_flag & leftBL){
                    double t0 = (submeshes + isubmesh-1)->t0;
                    double r = (submeshes + isubmesh-1)->r;
                    double Nel = (submeshes + isubmesh-1)->submesh_Nel;
                    min_elem_size = t0*pow(r,Nel-1);
                }

                // On max of the node
                if ((submeshes + isubmesh)->pumi_flag & leftBL){
                    max_elem_size = (submeshes + isubmesh)->t0;
                }
                if ((submeshes + isubmesh)->pumi_flag & uniform){
                    max_elem_size = (submeshes + isubmesh)->t0;
                }
                if ((submeshes + isubmesh)->pumi_flag & rightBL){
                    double t0 = (submeshes + isubmesh)->t0;
                    double r = (submeshes + isubmesh)->r;
                    double Nel = (submeshes + isubmesh)->submesh_Nel;
                    max_elem_size = t0*pow(r,Nel-1);
                }

                return max_elem_size/min_elem_size;
            }
        }
    }
}



double pumi_return_elemsize(pumi_mesh_t *pumi_mesh, int index, int offset, int dir){
    pumi_submesh_t *submeshes;
    int Nel_total, nsubmeshes, elem, isubmesh;
    if (dir == pumi_x1){
        submeshes = (pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1;
        Nel_total = pumi_mesh->pumi_Nel_total_x1;
        nsubmeshes = pumi_mesh->nsubmeshes_x1;
    }
    else{
        submeshes = (pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2;
        Nel_total = pumi_mesh->pumi_Nel_total_x2;
        nsubmeshes = pumi_mesh->nsubmeshes_x2;
    }

    elem = index+offset;

    if (elem < 0){
        elem = 0;
    }
    if (elem >= Nel_total){
        elem = Nel_total-1;
    }

    for (isubmesh=0; isubmesh<nsubmeshes; isubmesh++){
        int submesh_min_elem = (submeshes + isubmesh)->Nel_cumulative;
        int submesh_max_elem = (submeshes + isubmesh)->Nel_cumulative + (submeshes + isubmesh)->submesh_Nel-1;

        if (elem >= submesh_min_elem && elem <= submesh_max_elem){
            int local_cell = elem - submesh_min_elem;
            //return (pumi_calc_elem_size_x2(pumi_mesh, isubmesh, local_cell));
            return (pumi_calc_elem_size_fnptr[dir][isubmesh](pumi_mesh, isubmesh, local_cell));
        }
    }
}


/*
* \brief Returns smallest element size in the mesh
* \param *pumi_mesh pointer object to struct pumi_mesh
*/
double pumi_return_smallest_elemsize(pumi_mesh_t *pumi_mesh){
  double smallest_elemsize;
  int isubmesh = 0;

  if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->pumi_flag & leftBL){
    smallest_elemsize = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + (isubmesh))->t0;
  }
  else{
    if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->pumi_flag & rightBL){
      smallest_elemsize = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + (isubmesh))->t0;
    }
    else{
      smallest_elemsize = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->t0;
    }
  }
  for (isubmesh=1; isubmesh<pumi_mesh->nsubmeshes_x1; isubmesh++){
    double new_smallest_elemsize;
    if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->pumi_flag & leftBL){
      new_smallest_elemsize = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + (isubmesh))->t0;
    }
    else{
      if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->pumi_flag & rightBL){
        new_smallest_elemsize = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + (isubmesh))->t0;
      }
      else{
        new_smallest_elemsize = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->t0;
      }
    }

    if (new_smallest_elemsize < smallest_elemsize){
      smallest_elemsize = new_smallest_elemsize;
    }
  }

  return smallest_elemsize;
}

int pumi_locate_submesh_x1(pumi_mesh_t *pumi_mesh, double coords){
    int isubmesh, submeshID;
    int submesh_located = 0;
    for (isubmesh=1; isubmesh<pumi_mesh->nsubmeshes_x1; isubmesh++){
        if (coords < ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_min){
            submeshID = isubmesh-1;
            submesh_located++;
            break;
        }
    }
    if (!(submesh_located)){
        submeshID = pumi_mesh->nsubmeshes_x1-1;
    }
    return submeshID;
}

int pumi_locate_submesh_x2(pumi_mesh_t *pumi_mesh, double coords){
    int isubmesh, submeshID;
    int submesh_located = 0;
    for (isubmesh=1; isubmesh<pumi_mesh->nsubmeshes_x2; isubmesh++){
        if (coords < ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->coord_min){
            submeshID = isubmesh-1;
            submesh_located++;
            break;
        }
    }
    if (!(submesh_located)){
        submeshID = pumi_mesh->nsubmeshes_x2-1;
    }
    return submeshID;
}

/*
* \brief Locates submesh ID and local cell ID of a initialized particle with global search and analytically
* \param *pumi_mesh pointer object to struct pumi_mesh
* \param coords - new coordinate of the particle
* \param prev_submeshID - old submesh ID of the pushed particle (i.e. before the push)
* \param[out] pointers to new submesh ID and new local cell which will be populated inside the routine
*/
void pumi_locate_submesh_and_cell(pumi_mesh_t *pumi_mesh, double coords, int *submeshID, int *cellID, int dir){
    *submeshID = pumi_locatesubmesh_fnptr[dir](pumi_mesh, coords);
    *cellID = pumi_locatecell_fnptr[dir][*submeshID](pumi_mesh, *submeshID, coords);
}

int pumi_update_submesh_x1(pumi_mesh_t *pumi_mesh, double coords, int prev_submeshID, int *prev_cellID){
    int submeshID = prev_submeshID;
    while(coords<((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + submeshID)->coord_min){
        submeshID -= 1;
        *prev_cellID = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + submeshID)->submesh_Nel - 1;
    }

    while(coords>((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + submeshID)->coord_max){
        submeshID += 1;
        *prev_cellID = 0;
    }
    return submeshID;
}

int pumi_update_submesh_x2(pumi_mesh_t *pumi_mesh, double coords, int prev_submeshID, int *prev_cellID){
    int submeshID = prev_submeshID;
    while(coords<((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + submeshID)->coord_min){
        submeshID -= 1;
        *prev_cellID = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + submeshID)->submesh_Nel - 1;
    }

    while(coords>((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + submeshID)->coord_max){
        submeshID += 1;
        *prev_cellID = 0;
    }
    return submeshID;
}

/*
* \brief Calculates new submesh ID and new local cell ID of a pushed particle using adjacency searches
* \param *pumi_mesh pointer object to struct pumi_mesh
* \param coords - new coordinate of the particle
* \param prev_submeshID - old submesh ID of the pushed particle (i.e. before the push)
* \param prev_cellID - old local cell ID of the pushed particle (i.e. before the push)
* \param[out] pointers to new submesh ID and new local cell which will be populated inside the routine
*/
void pumi_update_submesh_and_update_cell(pumi_mesh_t *pumi_mesh, double coords, int prev_submeshID, int prev_cellID, int *submeshID, int *cellID, int dir){
    *submeshID = pumi_updatesubmesh_fnptr[dir](pumi_mesh, coords, prev_submeshID, &prev_cellID);
    *cellID = pumi_updatecell_fnptr[dir][*submeshID](pumi_mesh, *submeshID, prev_cellID, coords);
}

/*
* \brief subroutine to call relevant weight-calculate routine using function pointers
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the block
* \param[in] local cell ID in the block
* \param[in] coord coordinate of the particle nodal weight is to be evaluated
* \param[out] pointers to global cell and weight2 which will be populated inside the routine
*/
void pumi_calc_weights(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell, double coord, int *global_cell, double* weight, int dir){
    pumi_calc_weights_fnptr[dir][isubmesh](pumi_mesh, isubmesh, local_cell, coord, global_cell, weight);
}

/*
* \brief subroutine to locate the cell number of a particle inside a uniform block
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the uniform block
* \param[in] coord coordinate of the particle whose cell number and local weights is to be evaluated
*/
int pumi_locatecell_in_uni_x1(pumi_mesh_t *pumi_mesh, int isubmesh_x1, double coord_x1){
    int icell_x1 = (coord_x1 - ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh_x1)->coord_min)/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh_x1)->t0;
    return icell_x1;
}

int pumi_locatecell_in_uni_x2(pumi_mesh_t *pumi_mesh, int isubmesh_x2, double coord_x2){
    int icell_x2 = (coord_x2 - ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh_x2)->coord_min)/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh_x2)->t0;
    return icell_x2;
}

/*
* \brief subroutine to update the cell number of a particle inside a uniform block
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the uniform block
* \param[in] local cell ID of particle in the uniform block
* \param[in] coord coordinate of the particle whose cell number and local weights is to be evaluated
*/
int pumi_updatecell_in_uni_x1(pumi_mesh_t *pumi_mesh, int isubmesh, int icell, double coord){
    icell = (coord - ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_min)/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->t0;
    return icell;
}

int pumi_updatecell_in_uni_x2(pumi_mesh_t *pumi_mesh, int isubmesh, int icell, double coord){
    icell = (coord - ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->coord_min)/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->t0;
    return icell;
}

/*
* \brief subroutine to calculate golbal cell ID and weight contribution of a particle inside a uniform block
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the uniform block
* \param[in] local cell ID of particle in the uniform block
* \param[in] coord coordinate of the particle whose cell number and local weights is to be evaluated
*/
void pumi_calc_weights_in_uni_x1(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell, double coord, int *global_cell, double* weight){
    *weight = (coord - (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_min + ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->t0*local_cell))/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->t0;
    *global_cell = local_cell + ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->Nel_cumulative;
}

void pumi_calc_weights_in_uni_x2(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell, double coord, int *global_cell, double* weight){
    *weight = (coord - (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->coord_min + ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->t0*local_cell))/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->t0;
    *global_cell = local_cell + ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->Nel_cumulative;
}

/*
* \brief subroutine to locate the cell number of a particle inside a leftBL block
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the leftBL block
* \param[in] coord coordinate of the particle whose cell number and local weights is to be evaluated
*/
int pumi_locatecell_in_leftBL(pumi_mesh_t *pumi_mesh, int isubmesh, double coord){
    int icell = log(1 + (fabs(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_min-coord))*((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r_t0_ratio)/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->log_r;
    return icell;
}

int pumi_locatecell_in_bottomBL(pumi_mesh_t *pumi_mesh, int isubmesh, double coord){
    int icell = log(1 + (fabs(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->coord_min-coord))*((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->r_t0_ratio)/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->log_r;
    return icell;
}

/*
* \brief subroutine to update the local cell number of a particle inside a leftBL block with adjacency search
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the leftBL block
* \param[in] local cell ID in the leftBL block
* \param[in] coord coordinate of the particle nodal weight is to be evaluated
*/
int pumi_updatecell_in_leftBL_cached(pumi_mesh_t *pumi_mesh, int isubmesh, int icell, double coord){
    while(coord < *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + icell)){
        icell -= 1;
    }

    while(coord > *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + (icell+1))){
        icell += 1;
    }
    return icell;
}

int pumi_updatecell_in_bottomBL_cached(pumi_mesh_t *pumi_mesh, int isubmesh, int icell, double coord){
    while(coord < *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->BL_coords + icell)){
        icell -= 1;
    }

    while(coord > *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->BL_coords + (icell+1))){
        icell += 1;
    }
    return icell;
}
/*
* \brief subroutine to update the local cell number of a particle inside a leftBL block analytically
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the leftBL block
* \param[in] local cell ID in the leftBL block
* \param[in] coord coordinate of the particle nodal weight is to be evaluated
*/
int pumi_updatecell_in_leftBL_analytic(pumi_mesh_t *pumi_mesh, int isubmesh, int icell, double coord){
    icell = log(1 + (fabs(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_min-coord))*((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r_t0_ratio)/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->log_r;
    return icell;
}

int pumi_updatecell_in_bottomBL_analytic(pumi_mesh_t *pumi_mesh, int isubmesh, int icell, double coord){
    icell = log(1 + (fabs(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->coord_min-coord))*((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->r_t0_ratio)/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->log_r;
    return icell;
}

/*
* \brief subroutine to calculate golbal cell ID and weight contribution of a particle inside a leftBL block analytically
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the leftBL block
* \param[in] local cell ID in the leftBL block
* \param[in] coord coordinate of the particle nodal weight is to be evaluated
* \param[out] pointers to global cell and weight2 which will be populated inside the routine
*/
void pumi_calc_weights_in_leftBL_analytic(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell, double coord, int *global_cell, double* weight){
    double r_power_cell = pow(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r,local_cell);
    *global_cell = local_cell + ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->Nel_cumulative;
    *weight = (coord - (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_min + (r_power_cell-1.0)/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r_t0_ratio))/(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->t0*r_power_cell);
}

void pumi_calc_weights_in_bottomBL_analytic(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell, double coord, int *global_cell, double* weight){
    double r_power_cell = pow(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->r,local_cell);
    *global_cell = local_cell + ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->Nel_cumulative;
    *weight = (coord - (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->coord_min + (r_power_cell-1.0)/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->r_t0_ratio))/(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->t0*r_power_cell);
}

/*
* \brief subroutine to calculate golbal cell ID and weight contribution of a particle inside a leftBL block using cached elementsize and nodal coords
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the leftBL block
* \param[in] local cell ID in the leftBL block
* \param[in] coord coordinate of the particle nodal weight is to be evaluated
* \param[out] pointers to global cell and weight2 which will be populated inside the routine
*/
void pumi_calc_weights_in_leftBL_cached(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell, double coord, int *global_cell, double* weight){
    *global_cell = local_cell + ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->Nel_cumulative;
//    *weight = (coord - (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->x_left + (*(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->leftBL_elemsize + local_cell) - ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->lBL_t0)/(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->left_r - 1.0)))/(*(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->leftBL_elemsize + local_cell));
    *weight = (coord - *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + local_cell))/(*(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + local_cell));
}

void pumi_calc_weights_in_bottomBL_cached(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell, double coord, int *global_cell, double* weight){
    *global_cell = local_cell + ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->Nel_cumulative;
//    *weight = (coord - (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->x_left + (*(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->leftBL_elemsize + local_cell) - ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->lBL_t0)/(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->left_r - 1.0)))/(*(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->leftBL_elemsize + local_cell));
    *weight = (coord - *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->BL_coords + local_cell))/(*(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->BL_elemsize + local_cell));
}

/*
* \brief subroutine to locate the cell number of a particle inside a rightBL block
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the rightBL block
* \param[in] coord coordinate of the particle whose cell number and local weights is to be evaluated
*/
int pumi_locatecell_in_rightBL(pumi_mesh_t *pumi_mesh, int isubmesh, double coord){
    int icell = log(1 + (fabs(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_max-coord))*((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r_t0_ratio)/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->log_r;
    return ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->submesh_Nel - icell - 1;
}

int pumi_locatecell_in_topBL(pumi_mesh_t *pumi_mesh, int isubmesh, double coord){
    int icell = log(1 + (fabs(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->coord_max-coord))*((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->r_t0_ratio)/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->log_r;
    return ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->submesh_Nel - icell - 1;
}

/*
* \brief subroutine to update the local cell number of a particle inside a rightBL block with adjacency search
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the rightBL block
* \param[in] local cell ID in the rightBL block
* \param[in] coord coordinate of the particle nodal weight is to be evaluated
*/
int pumi_updatecell_in_rightBL_cached(pumi_mesh_t *pumi_mesh, int isubmesh, int icell, double coord){
    while(coord < *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + icell)){
        icell -= 1;
    }

    while(coord > *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + (icell+1))){
        icell += 1;
    }
    return icell;
}

int pumi_updatecell_in_topBL_cached(pumi_mesh_t *pumi_mesh, int isubmesh, int icell, double coord){
    while(coord < *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->BL_coords + icell)){
        icell -= 1;
    }

    while(coord > *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->BL_coords + (icell+1))){
        icell += 1;
    }
    return icell;
}

/*
* \brief subroutine to update the local cell number of a particle inside a rightBL block analytically
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the rightBL block
* \param[in] icell local cell ID in the rightBL block
* \param[in] coord coordinate of the particle nodal weight is to be evaluated
*/
int pumi_updatecell_in_rightBL_analytic(pumi_mesh_t *pumi_mesh, int isubmesh, int icell, double coord){
    icell = log(1 + (fabs(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_max-coord))*((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r_t0_ratio)/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->log_r;
    return ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->submesh_Nel - icell - 1;
}

int pumi_updatecell_in_topBL_analytic(pumi_mesh_t *pumi_mesh, int isubmesh, int icell, double coord){
    icell = log(1 + (fabs(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->coord_max-coord))*((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->r_t0_ratio)/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->log_r;
    return ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->submesh_Nel - icell - 1;
}

/*
* \brief subroutine to calculate golbal cell ID and weight contribution of a particle inside a rightBL block analytically
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the rightBL block
* \param[in] local cell ID in the rightBL block
* \param[in] coord coordinate of the particle nodal weight is to be evaluated
* \param[out] pointers to global cell and weight2 which will be populated inside the routine
*/
void pumi_calc_weights_in_rightBL_analytic(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell, double coord, int *global_cell, double* weight){
    local_cell = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->submesh_Nel - local_cell - 1;
    double r_power_cell = pow(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r,local_cell);
    *global_cell = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->Nel_cumulative + ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->submesh_Nel - local_cell - 1 ;
    *weight = 1 - ((((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_max - (r_power_cell-1.0)/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r_t0_ratio) - coord)/(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->t0*r_power_cell);
}

void pumi_calc_weights_in_topBL_analytic(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell, double coord, int *global_cell, double* weight){
    local_cell = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->submesh_Nel - local_cell - 1;
    double r_power_cell = pow(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->r,local_cell);
    *global_cell = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->Nel_cumulative + ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->submesh_Nel - local_cell - 1 ;
    *weight = 1 - ((((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->coord_max - (r_power_cell-1.0)/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->r_t0_ratio) - coord)/(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->t0*r_power_cell);
}

/*
* \brief subroutine to calculate golbal cell ID and weight contribution of a particle inside a rightBL block using cached elementsize and nodal coords
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the rightBL block
* \param[in] local cell ID in the rightBL block
* \param[in] coord coordinate of the particle nodal weight is to be evaluated
* \param[out] pointers to global cell and weight2 which will be populated inside the routine
*/
void pumi_calc_weights_in_rightBL_cached(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell, double coord, int *global_cell, double* weight){
//    local_cell = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->right_Nel - local_cell - 1;
    *global_cell = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->Nel_cumulative + local_cell ;
//    *weight = 1 - ((((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->x_right - (*(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->rightBL_elemsize + local_cell) - ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->rBL_t0)/(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->right_r-1.0)) - coord)/(*(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->rightBL_elemsize + local_cell));
    *weight = (coord - *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + local_cell))/(*(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + local_cell));
}

void pumi_calc_weights_in_topBL_cached(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell, double coord, int *global_cell, double* weight){
//    local_cell = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->right_Nel - local_cell - 1;
    *global_cell = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->Nel_cumulative + local_cell ;
//    *weight = 1 - ((((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->x_right - (*(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->rightBL_elemsize + local_cell) - ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->rBL_t0)/(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->right_r-1.0)) - coord)/(*(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->rightBL_elemsize + local_cell));
    *weight = (coord - *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->BL_coords + local_cell))/(*(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->BL_elemsize + local_cell));
}

/*
* \brief subroutine that returns global cell number from submesh ID and local cell ID
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the rightBL block
* \param[in] icell local cell ID in the rightBL block
*/
int pumi_global_cell_ID(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell){
    return (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->Nel_cumulative + local_cell);
}

/*
* \brief subroutine that calculates the element node coordinates from submesh and local cell ID
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the rightBL block
* \param[in] icell local cell ID in the rightBL block
* \param[out] pointer to variable where left node coord is to be stored
* \param[out] pointer to variable where right node coord is to be stored
*/
void pumi_calc_node_coords(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell, double *left_node, double *right_node){
    pumi_calc_node_coords_fnptr[isubmesh](pumi_mesh, isubmesh, local_cell, left_node, right_node);
}

/*
* \brief subroutine that calculates the element node coordinates in uniform block from submesh and local cell ID
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the rightBL block
* \param[in] icell local cell ID in the rightBL block
* \param[out] pointer to variable where left node coord is to be stored
* \param[out] pointer to variable where right node coord is to be stored
*/
void pumi_calc_node_coords_in_uni(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell, double *left_node, double *right_node){
    *left_node = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_min + ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->t0*local_cell;
    *right_node = *left_node + ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->t0;
}

/*
* \brief subroutine that calculates the element node coordinates in leftBL block using cached node coords, submesh and local cell ID
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the rightBL block
* \param[in] icell local cell ID in the rightBL block
* \param[out] pointer to variable where left node coord is to be stored
* \param[out] pointer to variable where right node coord is to be stored
*/
void pumi_calc_node_coords_in_leftBL_cached(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell, double *left_node, double *right_node){
    *left_node = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + local_cell);
    *right_node = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + (local_cell+1));
}

/*
* \brief subroutine that calculates the element node coordinates in leftBL analytically from submesh and local cell ID
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the rightBL block
* \param[in] icell local cell ID in the rightBL block
* \param[out] pointer to variable where left node coord is to be stored
* \param[out] pointer to variable where right node coord is to be stored
*/
void pumi_calc_node_coords_in_leftBL_analytic(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell, double *left_node, double *right_node){
    double r_power_cell = pow(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r,local_cell);
    *left_node = (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_min + (r_power_cell-1.0)/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r_t0_ratio);
    *right_node = *left_node + r_power_cell*((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->t0;
}

/*
* \brief subroutine that calculates the element node coordinates in rightBL block using cached node coords, submesh and local cell ID
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the rightBL block
* \param[in] icell local cell ID in the rightBL block
* \param[out] pointer to variable where left node coord is to be stored
* \param[out] pointer to variable where right node coord is to be stored
*/
void pumi_calc_node_coords_in_rightBL_cached(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell, double *left_node, double *right_node){
    *left_node = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + local_cell);
    *right_node = *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_coords + (local_cell+1));
}

/*
* \brief subroutine that calculates the element node coordinates in rightBL analytically from submesh and local cell ID
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the rightBL block
* \param[in] icell local cell ID in the rightBL block
* \param[out] pointer to variable where left node coord is to be stored
* \param[out] pointer to variable where right node coord is to be stored
*/
void pumi_calc_node_coords_in_rightBL_analytic(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell, double *left_node, double *right_node){
    local_cell = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->submesh_Nel - local_cell - 1;
    double r_power_cell = pow(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r,local_cell);
    *right_node = (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->coord_max - (r_power_cell-1.0)/((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r_t0_ratio);
    *left_node = *right_node - r_power_cell*((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->t0;
}

/*
* \brief subroutine that calculates the element size from submesh and local cell ID
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the rightBL block
* \param[in] icell local cell ID in the rightBL block
*/
double pumi_calc_elem_size(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell, int dir){
    return (pumi_calc_elem_size_fnptr[dir][isubmesh](pumi_mesh, isubmesh, local_cell));
}


/*
* \brief subroutine that calculates the element size in uniform block from submesh and local cell ID
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the rightBL block
* \param[in] icell local cell ID in the rightBL block
*/
double pumi_calc_elem_size_in_uni(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell){
    return (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->t0);
}

double pumi_calc_elem_size_in_uni_x1(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell){
    return (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->t0);
}

double pumi_calc_elem_size_in_uni_x2(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell){
    return (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->t0);
}

/*
* \brief subroutine that calculates the element size in leftBL block using cached element sizes, submesh and local cell ID
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the rightBL block
* \param[in] icell local cell ID in the rightBL block
*/
double pumi_calc_elem_size_in_leftBL_cached(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell){
    return *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + local_cell);
}

double pumi_calc_elem_size_in_bottomBL_cached(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell){
    return *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->BL_elemsize + local_cell);
}

/*
* \brief subroutine that calculates the element size in leftBL analytically from submesh and local cell ID
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the rightBL block
* \param[in] icell local cell ID in the rightBL block
*/
double pumi_calc_elem_size_in_leftBL_analytic(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell){
    double r_power_cell = pow(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r,local_cell);
    return (r_power_cell*((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->t0);
}

double pumi_calc_elem_size_in_bottomBL_analytic(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell){
    double r_power_cell = pow(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->r,local_cell);
    return (r_power_cell*((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->t0);
}

/*
* \brief subroutine that calculates the element size in rightBL block using cached element sizes, submesh and local cell ID
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the rightBL block
* \param[in] icell local cell ID in the rightBL block
*/
double pumi_calc_elem_size_in_rightBL_cached(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell){
    return *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->BL_elemsize + local_cell);
}

double pumi_calc_elem_size_in_topBL_cached(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell){
    return *(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->BL_elemsize + local_cell);
}

/*
* \brief subroutine that calculates the element size in rightBL analytically from submesh and local cell ID
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \param[in] submesh ID of the rightBL block
* \param[in] icell local cell ID in the rightBL block
*/
double pumi_calc_elem_size_in_rightBL_analytic(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell){
    local_cell = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->submesh_Nel - local_cell - 1;
    double r_power_cell = pow(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->r,local_cell);
    return (r_power_cell*((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->t0);
}

double pumi_calc_elem_size_in_topBL_analytic(pumi_mesh_t *pumi_mesh, int isubmesh, int local_cell){
    local_cell = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->submesh_Nel - local_cell - 1;
    double r_power_cell = pow(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->r,local_cell);
    return (r_power_cell*((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh)->t0);
}


/*
* \brief Assigns the appropriate subroutine for each submesh block to locate/update the local cell number of a particle in that submesh
* \param[in] *pumi_mesh pointer object to struct pumi_mesh
* \details Allocates memory to function pointer *pumi_locatecell_fnptr, *pumi_updatecell_fnptr, *pumi_calc_weights_fnptr
and assign relevant locate/update/weight-calculate pumi routines to each submesh during pumi mesh initialization
*/
/*
void pumi_initialize_locatecell_and_calcweights_functions(pumi_mesh_t *pumi_mesh){
    pumi_locatecell_fnptr = malloc(pumi_mesh->nsubmeshes_x1*sizeof(pumi_locatecell_ptr));
    pumi_updatecell_fnptr = malloc(pumi_mesh->nsubmeshes_x1*sizeof(pumi_updatecell_ptr));
    pumi_calc_weights_fnptr = malloc(pumi_mesh->nsubmeshes_x1*sizeof(pumi_calc_weights_ptr));
    pumi_calc_node_coords_fnptr = malloc(pumi_mesh->nsubmeshes_x1*sizeof(pumi_calc_node_coords_ptr));
    pumi_calc_elem_size_fnptr = (pumi_calc_elem_size_ptr**) malloc(MAX_DIM * sizeof(pumi_calc_elem_size_ptr *));
    pumi_calc_elem_size_fnptr[0] = (pumi_calc_elem_size_ptr*) malloc(pumi_mesh->nsubmeshes_x1 * sizeof(pumi_calc_elem_size_ptr));
    pumi_calc_elem_size_fnptr[1] = NULL;
    int isubmesh;
    for(isubmesh=0; isubmesh<pumi_mesh->nsubmeshes_x1; isubmesh++){
        if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->pumi_flag & leftBL){
            pumi_locatecell_fnptr[isubmesh] = &pumi_locatecell_in_leftBL;
            printf("submesh=%d -- leftBL locate cell routine initialized\n",isubmesh );
            if (pumi_mesh->BL_elem_coords_cache_flag){
                pumi_calc_weights_fnptr[isubmesh] = &pumi_calc_weights_in_leftBL_cached;
                pumi_updatecell_fnptr[isubmesh] = &pumi_updatecell_in_leftBL_cached;
                pumi_calc_node_coords_fnptr[isubmesh] = &pumi_calc_node_coords_in_leftBL_cached;
                pumi_calc_elem_size_fnptr[0][isubmesh] = &pumi_calc_elem_size_in_leftBL_cached;
                printf("submesh=%d -- leftBL calc weight and cell update (with cache) routines initialized\n",isubmesh );
            }
            else{
                pumi_calc_weights_fnptr[isubmesh] = &pumi_calc_weights_in_leftBL_analytic;
                pumi_updatecell_fnptr[isubmesh] = &pumi_updatecell_in_leftBL_analytic;
                pumi_calc_node_coords_fnptr[isubmesh] = &pumi_calc_node_coords_in_leftBL_analytic;
                pumi_calc_elem_size_fnptr[0][isubmesh] = &pumi_calc_elem_size_in_leftBL_analytic;
                printf("submesh=%d -- leftBL calc weight and cell update (without cache) routines initialized\n",isubmesh );
            }
        }
        else if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->pumi_flag & rightBL){
            pumi_locatecell_fnptr[isubmesh] = &pumi_locatecell_in_rightBL;
            printf("submesh=%d -- rightBL locate cell routine initialized\n",isubmesh );
            if (pumi_mesh->BL_elem_coords_cache_flag){
                pumi_calc_weights_fnptr[isubmesh] = &pumi_calc_weights_in_rightBL_cached;
                pumi_updatecell_fnptr[isubmesh] = &pumi_updatecell_in_rightBL_cached;
                pumi_calc_node_coords_fnptr[isubmesh] = &pumi_calc_node_coords_in_rightBL_cached;
                pumi_calc_elem_size_fnptr[0][isubmesh] = &pumi_calc_elem_size_in_rightBL_cached;
                printf("submesh=%d -- rightBL calc weights and cell update (with cache) routines initialized\n",isubmesh );
            }
            else{
                pumi_calc_weights_fnptr[isubmesh] = &pumi_calc_weights_in_rightBL_analytic;
                pumi_updatecell_fnptr[isubmesh] = &pumi_updatecell_in_rightBL_analytic;
                pumi_calc_node_coords_fnptr[isubmesh] = &pumi_calc_node_coords_in_rightBL_analytic;
                pumi_calc_elem_size_fnptr[0][isubmesh] = &pumi_calc_elem_size_in_rightBL_analytic;
                printf("submesh=%d -- rightBL calc weight and cell update (without cache) routines initialized\n",isubmesh );
            }
        }
        else if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->pumi_flag & uniform){
            pumi_locatecell_fnptr[isubmesh] = &pumi_locatecell_in_uni;
            pumi_updatecell_fnptr[isubmesh] = &pumi_updatecell_in_uni;
            pumi_calc_weights_fnptr[isubmesh] = &pumi_calc_weights_in_uni;
            pumi_calc_node_coords_fnptr[isubmesh] = &pumi_calc_node_coords_in_uni;
            pumi_calc_elem_size_fnptr[0][isubmesh] = &pumi_calc_elem_size_in_uni;
            printf("submesh=%d -- uniform routines initialized\n",isubmesh );
        }
        else{
            printf("Error in meshtype for submesh %d \n", isubmesh);
            exit(0);
        }
    }
}
*/
void pumi_initialize_locatecell_and_calcweights_functions(pumi_mesh_t *pumi_mesh){
    pumi_locatesubmesh_fnptr[0] = &pumi_locate_submesh_x1;
    pumi_locatesubmesh_fnptr[1] = &pumi_locate_submesh_x2;
    pumi_updatesubmesh_fnptr[0] = &pumi_update_submesh_x1;
    pumi_updatesubmesh_fnptr[1] = &pumi_update_submesh_x2;

    pumi_locatecell_fnptr = (pumi_locatecell_ptr**) malloc(MAX_DIM * sizeof(pumi_locatecell_ptr *));
    pumi_locatecell_fnptr[0] = (pumi_locatecell_ptr*) malloc(pumi_mesh->nsubmeshes_x1 * sizeof(pumi_locatecell_ptr));

    pumi_calc_elem_size_fnptr = (pumi_calc_elem_size_ptr**) malloc(MAX_DIM * sizeof(pumi_calc_elem_size_ptr *));
    pumi_calc_elem_size_fnptr[0] = (pumi_calc_elem_size_ptr*) malloc(pumi_mesh->nsubmeshes_x1 * sizeof(pumi_calc_elem_size_ptr));

    pumi_updatecell_fnptr = (pumi_updatecell_ptr**) malloc(MAX_DIM * sizeof(pumi_updatecell_ptr *));
    pumi_updatecell_fnptr[0] = (pumi_updatecell_ptr*) malloc(pumi_mesh->nsubmeshes_x1 * sizeof(pumi_updatecell_ptr));

    pumi_calc_weights_fnptr = (pumi_calc_weights_ptr**) malloc(MAX_DIM * sizeof(pumi_calc_weights_ptr *));
    pumi_calc_weights_fnptr[0] = (pumi_calc_weights_ptr*) malloc(pumi_mesh->nsubmeshes_x1 * sizeof(pumi_calc_weights_ptr));

    if (pumi_mesh->ndim == 1){
        pumi_locatecell_fnptr[1] = NULL;
        pumi_calc_elem_size_fnptr[1] = NULL;
        pumi_updatecell_fnptr[1] = NULL;
        pumi_calc_weights_fnptr[1] = NULL;
    }
    else{
        pumi_locatecell_fnptr[1] = (pumi_locatecell_ptr*) malloc(pumi_mesh->nsubmeshes_x2 * sizeof(pumi_locatecell_ptr));
        pumi_calc_elem_size_fnptr[1] = (pumi_calc_elem_size_ptr*) malloc(pumi_mesh->nsubmeshes_x2 * sizeof(pumi_calc_elem_size_ptr));
        pumi_updatecell_fnptr[1] = (pumi_updatecell_ptr*) malloc(pumi_mesh->nsubmeshes_x2 * sizeof(pumi_updatecell_ptr));
        pumi_calc_weights_fnptr[1] = (pumi_calc_weights_ptr*) malloc(pumi_mesh->nsubmeshes_x2 * sizeof(pumi_calc_weights_ptr));
    }

    pumi_calc_node_coords_fnptr = malloc(pumi_mesh->nsubmeshes_x1 * sizeof(pumi_calc_node_coords_ptr));

    int isubmesh, jsubmesh;
    for(isubmesh=0; isubmesh<pumi_mesh->nsubmeshes_x1; isubmesh++){
        if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->pumi_flag & leftBL){
            pumi_locatecell_fnptr[0][isubmesh] = &pumi_locatecell_in_leftBL;
            printf("submesh=X1-%d -- leftBL locate cell routine initialized\n",isubmesh );
            if (pumi_mesh->BL_elem_coords_cache_flag){
                pumi_calc_weights_fnptr[0][isubmesh] = &pumi_calc_weights_in_leftBL_cached;
                pumi_updatecell_fnptr[0][isubmesh] = &pumi_updatecell_in_leftBL_cached;
                pumi_calc_elem_size_fnptr[0][isubmesh] = &pumi_calc_elem_size_in_leftBL_cached;
                pumi_calc_node_coords_fnptr[isubmesh] = &pumi_calc_node_coords_in_leftBL_cached;
                printf("submesh=X1-%d -- leftBL calc weight and cell update (with cache) routines initialized\n",isubmesh );
            }
            else{
                pumi_calc_weights_fnptr[0][isubmesh] = &pumi_calc_weights_in_leftBL_analytic;
                pumi_updatecell_fnptr[0][isubmesh] = &pumi_updatecell_in_leftBL_analytic;
                pumi_calc_elem_size_fnptr[0][isubmesh] = &pumi_calc_elem_size_in_leftBL_analytic;
                pumi_calc_node_coords_fnptr[isubmesh] = &pumi_calc_node_coords_in_leftBL_analytic;
                printf("submesh=X1-%d -- leftBL calc weight and cell update (without cache) routines initialized\n",isubmesh );
            }
        }
        else if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->pumi_flag & rightBL){
            pumi_locatecell_fnptr[0][isubmesh] = &pumi_locatecell_in_rightBL;
            printf("submesh=X1-%d -- rightBL locate cell routine initialized\n",isubmesh );
            if (pumi_mesh->BL_elem_coords_cache_flag){
                pumi_calc_weights_fnptr[0][isubmesh] = &pumi_calc_weights_in_rightBL_cached;
                pumi_updatecell_fnptr[0][isubmesh] = &pumi_updatecell_in_rightBL_cached;
                pumi_calc_elem_size_fnptr[0][isubmesh] = &pumi_calc_elem_size_in_rightBL_cached;
                pumi_calc_node_coords_fnptr[isubmesh] = &pumi_calc_node_coords_in_rightBL_cached;
                printf("submesh=X1-%d -- rightBL calc weights and cell update (with cache) routines initialized\n",isubmesh );
            }
            else{
                pumi_calc_weights_fnptr[0][isubmesh] = &pumi_calc_weights_in_rightBL_analytic;
                pumi_updatecell_fnptr[0][isubmesh] = &pumi_updatecell_in_rightBL_analytic;
                pumi_calc_elem_size_fnptr[0][isubmesh] = &pumi_calc_elem_size_in_rightBL_analytic;
                pumi_calc_node_coords_fnptr[isubmesh] = &pumi_calc_node_coords_in_rightBL_analytic;
                printf("submesh=X1-%d -- rightBL calc weight and cell update (without cache) routines initialized\n",isubmesh );
            }
        }
        else if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->pumi_flag & uniform){
            pumi_locatecell_fnptr[0][isubmesh] = &pumi_locatecell_in_uni_x1;
            pumi_updatecell_fnptr[0][isubmesh] = &pumi_updatecell_in_uni_x1;
            pumi_calc_weights_fnptr[0][isubmesh] = &pumi_calc_weights_in_uni_x1;
            pumi_calc_elem_size_fnptr[0][isubmesh] = &pumi_calc_elem_size_in_uni_x1;
            pumi_calc_node_coords_fnptr[isubmesh] = &pumi_calc_node_coords_in_uni;
            printf("submesh=X1-%d -- uniform routines initialized\n",isubmesh );
        }
        else{
            printf("Error in meshtype for submesh %d \n", isubmesh);
            exit(0);
        }
    }
    printf("\n");
    if (pumi_mesh->ndim > 1){
        for(jsubmesh=0; jsubmesh<pumi_mesh->nsubmeshes_x2; jsubmesh++){
            if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->pumi_flag & bottomBL){
                pumi_locatecell_fnptr[1][jsubmesh] = &pumi_locatecell_in_bottomBL;
                printf("submesh=X2-%d -- bottomBL locate cell routine initialized\n",jsubmesh );
                if (pumi_mesh->BL_elem_coords_cache_flag){
                    pumi_calc_weights_fnptr[1][jsubmesh] = &pumi_calc_weights_in_bottomBL_cached;
                    pumi_updatecell_fnptr[1][jsubmesh] = &pumi_updatecell_in_bottomBL_cached;
                    pumi_calc_elem_size_fnptr[1][jsubmesh] = &pumi_calc_elem_size_in_bottomBL_cached;
                    printf("submesh=X2-%d -- bottomBL calc weight and cell update (with cache) routines initialized\n",jsubmesh );
                }
                else{
                    pumi_calc_weights_fnptr[1][jsubmesh] = &pumi_calc_weights_in_bottomBL_analytic;
                    pumi_updatecell_fnptr[1][jsubmesh] = &pumi_updatecell_in_bottomBL_analytic;
                    pumi_calc_elem_size_fnptr[1][jsubmesh] = &pumi_calc_elem_size_in_bottomBL_analytic;
                    printf("submesh=X2-%d -- bottomBL calc weight and cell update (without cache) routines initialized\n",jsubmesh );
                }
            }
            else if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->pumi_flag & topBL){
                pumi_locatecell_fnptr[1][jsubmesh] = &pumi_locatecell_in_topBL;
                printf("submesh=X2-%d -- topBL locate cell routine initialized\n",jsubmesh );
                if (pumi_mesh->BL_elem_coords_cache_flag){
                    pumi_calc_weights_fnptr[1][jsubmesh] = &pumi_calc_weights_in_topBL_cached;
                    pumi_updatecell_fnptr[1][jsubmesh] = &pumi_updatecell_in_topBL_cached;
                    pumi_calc_elem_size_fnptr[1][jsubmesh] = &pumi_calc_elem_size_in_topBL_cached;
                    printf("submesh=X2-%d -- topBL calc weights and cell update (with cache) routines initialized\n",jsubmesh );
                }
                else{
                    pumi_calc_weights_fnptr[1][jsubmesh] = &pumi_calc_weights_in_topBL_analytic;
                    pumi_updatecell_fnptr[1][jsubmesh] = &pumi_updatecell_in_topBL_analytic;
                    pumi_calc_elem_size_fnptr[1][jsubmesh] = &pumi_calc_elem_size_in_topBL_analytic;
                    printf("submesh=X2-%d -- topBL calc weight and cell update (without cache) routines initialized\n",jsubmesh );
                }
            }
            else if (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->pumi_flag & uniform){
                pumi_locatecell_fnptr[1][jsubmesh] = &pumi_locatecell_in_uni_x2;
                pumi_updatecell_fnptr[1][jsubmesh] = &pumi_updatecell_in_uni_x2;
                pumi_calc_weights_fnptr[1][jsubmesh] = &pumi_calc_weights_in_uni_x2;
                pumi_calc_elem_size_fnptr[1][jsubmesh] = &pumi_calc_elem_size_in_uni_x2;
                printf("submesh=X2-%d -- uniform routines initialized\n",jsubmesh );
            }
            else{
                printf("Error in meshtype for submesh %d \n", jsubmesh);
                exit(0);
            }
        }
    }
    printf("\n\n");
}

/*!
* \brief Deallocates/Frees the memory allocated to the funciton pointers pumi_*_fnptr
*/
/*
void pumi_finalize_locatecell_and_calcweights_functions(){
    free(pumi_locatecell_fnptr);
    free(pumi_updatecell_fnptr);
    free(pumi_calc_weights_fnptr);
    free(pumi_calc_node_coords_fnptr);
    free(pumi_calc_elem_size_fnptr[0]);
    free(pumi_calc_elem_size_fnptr[1]);
    free(pumi_calc_elem_size_fnptr);
}
*/
void pumi_finalize_locatecell_and_calcweights_functions(){
    free(pumi_locatecell_fnptr[0]);
    free(pumi_locatecell_fnptr[1]);
    free(pumi_locatecell_fnptr);
    free(pumi_updatecell_fnptr[0]);
    free(pumi_updatecell_fnptr[1]);
    free(pumi_updatecell_fnptr);
    free(pumi_calc_weights_fnptr[0]);
    free(pumi_calc_weights_fnptr[1]);
    free(pumi_calc_weights_fnptr);
    free(pumi_calc_elem_size_fnptr[0]);
    free(pumi_calc_elem_size_fnptr[1]);
    free(pumi_calc_elem_size_fnptr);
    free(pumi_calc_node_coords_fnptr);
}

int pumi_calc_elementID_and_nodeID_typeA(pumi_mesh_t* pumi_mesh, int isubmesh_x1, int isubmesh_x2, int kcell_x1, int kcell_x2, int *node1, int *node3){
    int nodeoffset1, nodeoffset3, elemoffset, elemID, icell_x2;
    icell_x2 = kcell_x2 - ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh_x2)->Nel_cumulative;
    nodeoffset1 = pumi_mesh->nodeoffset_start[isubmesh_x1][isubmesh_x2] + icell_x2*pumi_mesh->nodeoffset_skip_mid[isubmesh_x1][isubmesh_x2];
    nodeoffset3 = nodeoffset1 + pumi_mesh->nodeoffset_skip_mid[isubmesh_x1][isubmesh_x2];
    elemoffset = pumi_mesh->elemoffset_start[isubmesh_x1][isubmesh_x2] + icell_x2*pumi_mesh->elemoffset_skip[isubmesh_x2];
    elemID = kcell_x1 + pumi_mesh->pumi_Nel_total_x1*kcell_x2;
    *node1 = elemID + kcell_x2 - nodeoffset1;
    *node3 = elemID + kcell_x2 + pumi_mesh->pumi_Nnp_total_x1 - nodeoffset3;
    return (elemID-elemoffset);
}

int pumi_calc_elementID_and_nodeID_typeB(pumi_mesh_t* pumi_mesh, int isubmesh_x1, int isubmesh_x2, int kcell_x1, int kcell_x2, int *node1, int *node3){
    int nodeoffset1, nodeoffset3, index, elemoffset, elemID, icell_x2;
    icell_x2 = kcell_x2 - ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh_x2)->Nel_cumulative;
    index = (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh_x2)->submesh_Nel_minus_1-icell_x2)/(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh_x2)->submesh_Nel_minus_1);
    pumi_typeB_nodeoffset_fnptr[index](pumi_mesh, isubmesh_x1, isubmesh_x2, icell_x2, &nodeoffset1, &nodeoffset3);
    elemoffset = pumi_mesh->elemoffset_start[isubmesh_x1][isubmesh_x2] + icell_x2*pumi_mesh->elemoffset_skip[isubmesh_x2];
    elemID = kcell_x1 + pumi_mesh->pumi_Nel_total_x1*kcell_x2;
    *node1 = elemID + kcell_x2 - nodeoffset1;
    *node3 = elemID + kcell_x2 + pumi_mesh->pumi_Nnp_total_x1 - nodeoffset3;
    //if (icell_x2 <= 1){
    //    nodeoffset = pumi_mesh->nodeoffset_start[isubmesh_x1][isubmesh_x2] + icell_x2*pumi_mesh->nodeoffset_skip_bottom[isubmesh_x1][isubmesh_x2];
    //}
    //else{
    //    nodeoffset = pumi_mesh->nodeoffset_start[isubmesh_x1][isubmesh_x2] + pumi_mesh->nodeoffset_skip_bottom[isubmesh_x1][isubmesh_x2] + (icell_x2-1)*pumi_mesh->nodeoffset_skip_mid[isubmesh_x1][isubmesh_x2];
    //}
    //elemID = kcell_x1 + pumi_mesh->pumi_Nel_total_x1*kcell_x2 - (pumi_mesh->elemoffset_start[isubmesh_x1][isubmesh_x2] + icell_x2*pumi_mesh->elemoffset_skip[isubmesh_x2]);
    return (elemID-elemoffset);
}

void pumi_typeB_nodeoffset_expression2(pumi_mesh_t* pumi_mesh, int isubmesh_x1, int isubmesh_x2, int icell_x2, int *offset1, int *offset3){
    *offset1 = pumi_mesh->nodeoffset_start[isubmesh_x1][isubmesh_x2];
    *offset3 = *offset1 + pumi_mesh->nodeoffset_skip_bottom[isubmesh_x1][isubmesh_x2];
}

void pumi_typeB_nodeoffset_expression1(pumi_mesh_t* pumi_mesh, int isubmesh_x1, int isubmesh_x2, int icell_x2, int *offset1, int *offset3){
    *offset1 = pumi_mesh->nodeoffset_start[isubmesh_x1][isubmesh_x2] + pumi_mesh->nodeoffset_skip_bottom[isubmesh_x1][isubmesh_x2] + (icell_x2-1)*pumi_mesh->nodeoffset_skip_mid[isubmesh_x1][isubmesh_x2];
    *offset3 = *offset1 + pumi_mesh->nodeoffset_skip_mid[isubmesh_x1][isubmesh_x2];
}

int pumi_calc_elementID_and_nodeID_typeC(pumi_mesh_t* pumi_mesh, int isubmesh_x1, int isubmesh_x2, int kcell_x1, int kcell_x2, int *node1, int *node3){
    int nodeoffset1, nodeoffset3, index, elemoffset, elemID, icell_x2;
    icell_x2 = kcell_x2 - ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh_x2)->Nel_cumulative;
    index = icell_x2/(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh_x2)->submesh_Nel_minus_1);
    pumi_typeC_nodeoffset_fnptr[index](pumi_mesh, isubmesh_x1, isubmesh_x2, icell_x2, &nodeoffset1, &nodeoffset3);
    elemoffset = pumi_mesh->elemoffset_start[isubmesh_x1][isubmesh_x2] + icell_x2*pumi_mesh->elemoffset_skip[isubmesh_x2];
    elemID = kcell_x1 + pumi_mesh->pumi_Nel_total_x1*kcell_x2;
    *node1 = elemID + kcell_x2 - nodeoffset1;
    *node3 = elemID + kcell_x2 + pumi_mesh->pumi_Nnp_total_x1 - nodeoffset3;
    //if (icell_x2 == ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh_x2)->submesh_Nel){
    //    nodeoffset = pumi_mesh->nodeoffset_start[isubmesh_x1][isubmesh_x2] + (icell_x2-1)*pumi_mesh->nodeoffset_skip_mid[isubmesh_x1][isubmesh_x2] + pumi_mesh->nodeoffset_skip_top[isubmesh_x1][isubmesh_x2];
    //}
    //else{
    //    nodeoffset = pumi_mesh->nodeoffset_start[isubmesh_x1][isubmesh_x2] + icell_x2*pumi_mesh->nodeoffset_skip_mid[isubmesh_x1][isubmesh_x2];
    //}
    //elemID = kcell_x1 + pumi_mesh->pumi_Nel_total_x1*kcell_x2 - (pumi_mesh->elemoffset_start[isubmesh_x1][isubmesh_x2] + icell_x2*pumi_mesh->elemoffset_skip[isubmesh_x2]);
    return (elemID-elemoffset);
}

void pumi_typeC_nodeoffset_expression1(pumi_mesh_t* pumi_mesh, int isubmesh_x1, int isubmesh_x2, int icell_x2, int *offset1, int *offset3){
    *offset1 = pumi_mesh->nodeoffset_start[isubmesh_x1][isubmesh_x2] + icell_x2*pumi_mesh->nodeoffset_skip_mid[isubmesh_x1][isubmesh_x2];
    *offset3 = *offset1 + pumi_mesh->nodeoffset_skip_mid[isubmesh_x1][isubmesh_x2];
}

void pumi_typeC_nodeoffset_expression2(pumi_mesh_t* pumi_mesh, int isubmesh_x1, int isubmesh_x2, int icell_x2, int *offset1, int *offset3){
    *offset1 = pumi_mesh->nodeoffset_start[isubmesh_x1][isubmesh_x2] + icell_x2*pumi_mesh->nodeoffset_skip_mid[isubmesh_x1][isubmesh_x2];
    *offset3 = *offset1 + pumi_mesh->nodeoffset_skip_top[isubmesh_x1][isubmesh_x2];
}

int pumi_calc_elementID_and_nodeID_typeD(pumi_mesh_t* pumi_mesh, int isubmesh_x1, int isubmesh_x2, int kcell_x1, int kcell_x2, int *node1, int *node3){
    int nodeoffset1, nodeoffset3, index, elemoffset, elemID, icell_x2;
    icell_x2 = kcell_x2 - ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh_x2)->Nel_cumulative;
    index = icell_x2/(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh_x2)->submesh_Nel_minus_1) + 1 -
    (((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh_x2)->submesh_Nel-1-icell_x2)/(((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh_x2)->submesh_Nel-1);
    pumi_typeD_nodeoffset_fnptr[index](pumi_mesh, isubmesh_x1, isubmesh_x2, icell_x2, &nodeoffset1, &nodeoffset3);
    elemoffset = pumi_mesh->elemoffset_start[isubmesh_x1][isubmesh_x2] + icell_x2*pumi_mesh->elemoffset_skip[isubmesh_x2];
    elemID = kcell_x1 + pumi_mesh->pumi_Nel_total_x1*kcell_x2;
    *node1 = elemID + kcell_x2 - nodeoffset1;
    *node3 = elemID + kcell_x2 + pumi_mesh->pumi_Nnp_total_x1 - nodeoffset3;
    //if (icell_x2 <= 1){
    //    nodeoffset = pumi_mesh->nodeoffset_start[isubmesh_x1][isubmesh_x2] + icell_x2*pumi_mesh->nodeoffset_skip_bottom[isubmesh_x1][isubmesh_x2];
    //}
    //else if (icell_x2 == ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh_x2)->submesh_Nel){
    //    nodeoffset = pumi_mesh->nodeoffset_start[isubmesh_x1][isubmesh_x2] + pumi_mesh->nodeoffset_skip_bottom[isubmesh_x1][isubmesh_x2] + (icell_x2-2)*pumi_mesh->nodeoffset_skip_mid[isubmesh_x1][isubmesh_x2] + pumi_mesh->nodeoffset_skip_top[isubmesh_x1][isubmesh_x2];
    //}
    //else{
    //    nodeoffset = pumi_mesh->nodeoffset_start[isubmesh_x1][isubmesh_x2] + pumi_mesh->nodeoffset_skip_bottom[isubmesh_x1][isubmesh_x2] + (icell_x2-1)*pumi_mesh->nodeoffset_skip_mid[isubmesh_x1][isubmesh_x2];
    //}
    //elemID = kcell_x1 + pumi_mesh->pumi_Nel_total_x1*kcell_x2 - (pumi_mesh->elemoffset_start[isubmesh_x1][isubmesh_x2] + icell_x2*pumi_mesh->elemoffset_skip[isubmesh_x2]);
    return (elemID-elemoffset);
}

void pumi_typeD_nodeoffset_expression1(pumi_mesh_t* pumi_mesh, int isubmesh_x1, int isubmesh_x2, int icell_x2, int *offset1, int *offset3){
    *offset1 = pumi_mesh->nodeoffset_start[isubmesh_x1][isubmesh_x2];
    *offset3 = *offset1 + pumi_mesh->nodeoffset_skip_bottom[isubmesh_x1][isubmesh_x2];
}

void pumi_typeD_nodeoffset_expression2(pumi_mesh_t* pumi_mesh, int isubmesh_x1, int isubmesh_x2, int icell_x2, int *offset1, int *offset3){
    *offset1 = pumi_mesh->nodeoffset_start[isubmesh_x1][isubmesh_x2] + pumi_mesh->nodeoffset_skip_bottom[isubmesh_x1][isubmesh_x2] + (icell_x2-1)*pumi_mesh->nodeoffset_skip_mid[isubmesh_x1][isubmesh_x2];
    *offset3 = *offset1 + pumi_mesh->nodeoffset_skip_mid[isubmesh_x1][isubmesh_x2];
}

void pumi_typeD_nodeoffset_expression3(pumi_mesh_t* pumi_mesh, int isubmesh_x1, int isubmesh_x2, int icell_x2, int *offset1, int *offset3){
    *offset1 = pumi_mesh->nodeoffset_start[isubmesh_x1][isubmesh_x2] + pumi_mesh->nodeoffset_skip_bottom[isubmesh_x1][isubmesh_x2] + (icell_x2-1)*pumi_mesh->nodeoffset_skip_mid[isubmesh_x1][isubmesh_x2];
    *offset3 = *offset1 + pumi_mesh->nodeoffset_skip_top[isubmesh_x1][isubmesh_x2];
}

int pumi_calc_elementID_and_nodeID(pumi_mesh_t* pumi_mesh, int isubmesh_x1, int isubmesh_x2, int kcell_x1, int kcell_x2, int *node1, int *node3){
    return pumi_nodeID_fnptr[isubmesh_x1][isubmesh_x2](pumi_mesh, isubmesh_x1, isubmesh_x2, kcell_x1, kcell_x2, node1, node3);
}

int pumi_calc_elementID_and_nodeID_with_global_offset(pumi_mesh_t* pumi_mesh, int isubmesh_x1, int isubmesh_x2, int kcell_x1, int kcell_x2, int *node1, int *node3){
    int nodeoffset1, nodeoffset3, elemoffset, elemID, icell_x2;
    nodeoffset1 = pumi_mesh->global_nodeoffset[isubmesh_x1][kcell_x2];
    nodeoffset3 = pumi_mesh->global_nodeoffset[isubmesh_x1][kcell_x2+1];
    icell_x2 = kcell_x2 - ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + isubmesh_x2)->Nel_cumulative;
    elemoffset = pumi_mesh->elemoffset_start[isubmesh_x1][isubmesh_x2] + icell_x2*pumi_mesh->elemoffset_skip[isubmesh_x2];
    elemID = kcell_x1 + pumi_mesh->pumi_Nel_total_x1*kcell_x2;
    *node1 = elemID + kcell_x2 - nodeoffset1;
    *node3 = elemID + kcell_x2 + pumi_mesh->pumi_Nnp_total_x1 - nodeoffset3;
    return (elemID-elemoffset);
}

int pumi_calc_elementID_and_nodeID_on_fullmesh(pumi_mesh_t* pumi_mesh, int isubmesh_x1, int isubmesh_x2, int kcell_x1, int kcell_x2, int *node1, int *node3){
    int elemID = kcell_x1 + pumi_mesh->pumi_Nel_total_x1*kcell_x2;
    *node1 = elemID + kcell_x2;
    *node3 = *node1 + pumi_mesh->pumi_Nnp_total_x1;
    return elemID;
}

int pumi_dummy_elem_node_ID(double coord_x1, double coord_x2, double dx1, double dx2, int Nel_total_x1, int *node1, int *node3){
    int kcell_x1 = floor(coord_x1/dx1);
    int kcell_x2 = floor(coord_x2/dx2);
    int kcell = kcell_x2*Nel_total_x1+kcell_x1;
    *node1 = kcell + kcell_x2;
    *node3 = *node1 + Nel_total_x1 + 1;
    return kcell;
}

int pumi_dummy_elem_node_ID_v2(int kcell_x1, int kcell_x2, double dx1, double dx2, int Nel_total_x1, int *node1, int *node3){
    int kcell = kcell_x2*Nel_total_x1+kcell_x1;
    *node1 = kcell + kcell_x2;
    *node3 = *node1 + Nel_total_x1 + 1;
    return kcell;
}

bool pumi_is_fullmesh(pumi_mesh_t *pumi_mesh){
    bool is_fullmesh = true;
    int isubmesh, jsubmesh;
    for (jsubmesh=0; jsubmesh<pumi_mesh->nsubmeshes_x2; jsubmesh++){
        for (isubmesh=0; isubmesh<pumi_mesh->nsubmeshes_x1; isubmesh++){
            if(!(pumi_mesh->isactive[isubmesh][jsubmesh])){
                is_fullmesh = false;
            }
        }
    }
    return is_fullmesh;
}

bool pumi_is_node_active(pumi_mesh_t *pumi_mesh, int node){
    int node_x1, node_x2;
    node_x2 = node/pumi_mesh->pumi_Nel_total_x1;
    node_x1 = node - node_x2*pumi_mesh->pumi_Nel_total_x1;
    int isubmesh, jsubmesh, local_x1_node, local_x2_node;
    bool left_edge, right_edge, bottom_edge, top_edge;

    for (isubmesh=0; isubmesh<pumi_mesh->nsubmeshes_x1; isubmesh++){

        int submesh_left_node = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->Nel_cumulative;
        int submesh_right_node = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->Nel_cumulative + ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->submesh_Nel;
        left_edge =  false;
        right_edge = false;
        if (node_x1 >= submesh_left_node && node_x1 <= submesh_right_node){
            local_x1_node = node_x1 - submesh_left_node;
            if (local_x1_node == 0){
                left_edge = true;
            }
            if (local_x1_node == ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->submesh_Nel){
                right_edge = true;
            }
            break;
        }
    }

    for (jsubmesh=0; jsubmesh<pumi_mesh->nsubmeshes_x2; jsubmesh++){

        int submesh_bottom_node = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->Nel_cumulative;
        int submesh_top_node = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->Nel_cumulative + ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->submesh_Nel;
        bottom_edge =  false;
        top_edge = false;
        if (node_x2 >= submesh_bottom_node && node_x2 <= submesh_top_node){
            local_x2_node = node_x2 - submesh_bottom_node;
            if (local_x2_node == 0){
                bottom_edge = true;
            }
            if (local_x2_node == ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->submesh_Nel){
                top_edge = true;
            }
            break;
        }
    }

    //*isubmesh_x1 = isubmesh;
    //*inp_x1 = local_x1_node;
    //*isubmesh_x2 = jsubmesh;
    //*inp_x2 = local_x2_node;

    if (pumi_mesh->isactive[isubmesh][jsubmesh]){
        return true;
    }
    else{
        if (!left_edge && !right_edge && !bottom_edge && !top_edge){
            return false;
        }
        else{
            if (left_edge & !top_edge & !bottom_edge){
                if (isubmesh==0){
                    return false;
                }
                else{
                    if (pumi_mesh->isactive[isubmesh-1][jsubmesh]){
                        //*isubmesh_x1 = isubmesh-1;
                        //*inp_x1 = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh-1)->submesh_Nel;
                        return true;
                    }
                    else{
                        return false;
                    }
                }
            }

            if (left_edge & top_edge){
                if (jsubmesh==pumi_mesh->nsubmeshes_x2-1){
                    if (isubmesh==0){
                        return false;
                    }
                    else{
                        if(pumi_mesh->isactive[isubmesh-1][jsubmesh]){
                            //*isubmesh_x1 = isubmesh-1;
                            //*inp_x1 = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh-1)->submesh_Nel;
                            return true;
                        }
                        else{
                            return false;
                        }
                    }
                }
                else{
                    if (isubmesh==0){
                        if(pumi_mesh->isactive[isubmesh][jsubmesh+1]){
                            //*isubmesh_x2 = jsubmesh+1;
                            //*inp_x2 = 0;
                            return true;
                        }
                        else{
                            return false;
                        }
                    }
                    else{
                        if (pumi_mesh->isactive[isubmesh-1][jsubmesh] | pumi_mesh->isactive[isubmesh-1][jsubmesh+1] | pumi_mesh->isactive[isubmesh][jsubmesh+1]){
                            return true;
                        }
                        /*if (pumi_mesh->isactive[isubmesh-1][jsubmesh]){
                            *isubmesh_x1 = isubmesh-1;
                            *inp_x1 = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh-1)->submesh_Nel;
                            return true;
                        }
                        else if (pumi_mesh->isactive[isubmesh-1][jsubmesh+1]){
                            *isubmesh_x1 = isubmesh-1;
                            *inp_x1 = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh-1)->submesh_Nel;
                            *isubmesh_x2 = jsubmesh+1;
                            *inp_x2 = 0;
                            return true;
                        }
                        else if (pumi_mesh->isactive[isubmesh][jsubmesh+1]){
                            *isubmesh_x2 = jsubmesh+1;
                            *inp_x2 = 0;
                            return true;
                        }*/
                        else{
                            return false;
                        }
                    }
                }
            }

            if (top_edge & !left_edge & !right_edge){
                if (jsubmesh==pumi_mesh->nsubmeshes_x2-1){
                    return false;
                }
                else{
                    if (pumi_mesh->isactive[isubmesh][jsubmesh+1]){
                        //*isubmesh_x2 = jsubmesh+1;
                        //*inp_x2 = 0;
                        return true;
                    }
                    else{
                        return false;
                    }
                }
            }

            if (top_edge & right_edge){
                if (jsubmesh==pumi_mesh->nsubmeshes_x2-1){
                    if (isubmesh==pumi_mesh->nsubmeshes_x1-1){
                        return false;
                    }
                    else{
                        if(pumi_mesh->isactive[isubmesh+1][jsubmesh]){
                            //*isubmesh_x1 = isubmesh+1;
                            //*inp_x1 = 0;
                            return true;
                        }
                        else{
                            return false;
                        }
                    }
                }
                else{
                    if (isubmesh==pumi_mesh->nsubmeshes_x1-1){
                        if(pumi_mesh->isactive[isubmesh][jsubmesh+1]){
                            //*isubmesh_x2 = jsubmesh+1;
                            //*inp_x2 = 0;
                            return true;
                        }
                        else{
                            return false;
                        }
                    }
                    else{
                        if (pumi_mesh->isactive[isubmesh+1][jsubmesh] | pumi_mesh->isactive[isubmesh+1][jsubmesh+1] | pumi_mesh->isactive[isubmesh][jsubmesh+1]){
                            return true;
                        }
                        /*if (pumi_mesh->isactive[isubmesh+1][jsubmesh]){
                            *isubmesh_x1 = isubmesh+1;
                            *inp_x1 = 0;
                            return true;
                        }
                        else if (pumi_mesh->isactive[isubmesh+1][jsubmesh+1]){
                            *isubmesh_x1 = isubmesh+1;
                            *inp_x1 = 0;
                            *isubmesh_x2 = jsubmesh+1;
                            *inp_x2 = 0;
                            return true;
                        }
                        else if (pumi_mesh->isactive[isubmesh][jsubmesh+1]){
                            *isubmesh_x2 = jsubmesh+1;
                            *inp_x2 = 0;
                            return true;
                        }*/
                        else{
                            return false;
                        }
                    }
                }
            }

            if (right_edge & !top_edge & !bottom_edge){
                if (isubmesh==pumi_mesh->nsubmeshes_x1-1){
                    return false;
                }
                else{
                    if (pumi_mesh->isactive[isubmesh+1][jsubmesh]){
                        //*isubmesh_x1 = isubmesh+1;
                        //*inp_x1 = 0;
                        return true;
                    }
                    else{
                        return false;
                    }
                }
            }

            if (right_edge & bottom_edge){
                if (jsubmesh==0){
                    if (isubmesh==pumi_mesh->nsubmeshes_x1-1){
                        return false;
                    }
                    else{
                        if(pumi_mesh->isactive[isubmesh+1][jsubmesh]){
                            //*isubmesh_x1 = isubmesh+1;
                            //*inp_x1 = 0;
                            return true;
                        }
                        else{
                            return false;
                        }
                    }
                }
                else{
                    if (isubmesh==pumi_mesh->nsubmeshes_x1-1){
                        if(pumi_mesh->isactive[isubmesh][jsubmesh-1]){
                            //*isubmesh_x2 = jsubmesh-1;
                            //*inp_x2 = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh-1)->submesh_Nel;
                            return true;
                        }
                        else{
                            return false;
                        }
                    }
                    else{
                        if (pumi_mesh->isactive[isubmesh+1][jsubmesh] | pumi_mesh->isactive[isubmesh+1][jsubmesh-1] | pumi_mesh->isactive[isubmesh][jsubmesh-1]){
                            return true;
                        }
                        /*if (pumi_mesh->isactive[isubmesh+1][jsubmesh]){
                            *isubmesh_x1 = isubmesh+1;
                            *inp_x1 = 0;
                            return true;
                        }
                        else if (pumi_mesh->isactive[isubmesh+1][jsubmesh-1]){
                            *isubmesh_x1 = isubmesh+1;
                            *inp_x1 = 0;
                            *isubmesh_x2 = jsubmesh-1;
                            *inp_x2 = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh-1)->submesh_Nel;
                            return true;
                        }
                        else if (pumi_mesh->isactive[isubmesh][jsubmesh-1]){
                            *isubmesh_x2 = jsubmesh-1;
                            *inp_x2 = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh-1)->submesh_Nel;
                            return true;
                        }*/
                        else{
                            return false;
                        }
                    }
                }
            }

            if (bottom_edge & !left_edge &!right_edge){
                if (jsubmesh==0){
                    return false;
                }
                else{
                    if (pumi_mesh->isactive[isubmesh][jsubmesh-1]){
                        //*isubmesh_x2 = jsubmesh-1;
                        //*inp_x2 = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh-1)->submesh_Nel;
                        return true;
                    }
                    else{
                        return false;
                    }
                }
            }

            if (bottom_edge & left_edge){
                if (jsubmesh==0){
                    if (isubmesh==0){
                        return false;
                    }
                    else{
                        if(pumi_mesh->isactive[isubmesh-1][jsubmesh]){
                            //*isubmesh_x1 = isubmesh-1;
                            //*inp_x1 = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh-1)->submesh_Nel;
                            return true;
                        }
                        else{
                            return false;
                        }
                    }
                }
                else{
                    if (isubmesh==0){
                        if(pumi_mesh->isactive[isubmesh][jsubmesh-1]){
                            //*isubmesh_x2 = jsubmesh-1;
                            //*inp_x2 = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh-1)->submesh_Nel;
                            return true;
                        }
                        else{
                            return false;
                        }
                    }
                    else{
                        if (pumi_mesh->isactive[isubmesh-1][jsubmesh] | pumi_mesh->isactive[isubmesh-1][jsubmesh-1] | pumi_mesh->isactive[isubmesh][jsubmesh-1]){
                            return true;
                        }
                        /*if (pumi_mesh->isactive[isubmesh-1][jsubmesh]){
                            *isubmesh_x1 = isubmesh-1;
                            *inp_x1 = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh-1)->submesh_Nel;
                            return true;
                        }
                        else if (pumi_mesh->isactive[isubmesh-1][jsubmesh-1]){
                            *isubmesh_x1 = isubmesh-1;
                            *inp_x1 = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh-1)->submesh_Nel;
                            *isubmesh_x2 = jsubmesh-1;
                            *inp_x2 = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh-1)->submesh_Nel;
                            return true;
                        }
                        else if (pumi_mesh->isactive[isubmesh][jsubmesh-1]){
                            *isubmesh_x2 = jsubmesh-1;
                            *inp_x2 = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh-1)->submesh_Nel;
                            return true;
                        }*/
                        else{
                            return false;
                        }
                    }
                }

            }
        }
    }

}

void pumi_node_ID(pumi_mesh_t *pumi_mesh, int node_x1, int node_x2, bool *is_active_node, int *nodeID){
    int isubmesh, jsubmesh, local_x1_node, local_x2_node, kcell_x1, kcell_x2, node1, node3;
    bool left_edge, right_edge, bottom_edge, top_edge;

    for (isubmesh=0; isubmesh<pumi_mesh->nsubmeshes_x1; isubmesh++){

        int submesh_left_node = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->Nel_cumulative;
        int submesh_right_node = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->Nel_cumulative + ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->submesh_Nel;
        left_edge =  false;
        right_edge = false;
        if (node_x1 >= submesh_left_node && node_x1 <= submesh_right_node){
            local_x1_node = node_x1 - submesh_left_node;
            if (local_x1_node == 0){
                left_edge = true;
                kcell_x1 = node_x1;
            }
            else if (local_x1_node == ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->submesh_Nel){
                right_edge = true;
                kcell_x1 = node_x1-1;
            }
            else{
                kcell_x1 = node_x1-1;
            }
            break;
        }
    }

    for (jsubmesh=0; jsubmesh<pumi_mesh->nsubmeshes_x2; jsubmesh++){

        int submesh_bottom_node = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->Nel_cumulative;
        int submesh_top_node = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->Nel_cumulative + ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->submesh_Nel;
        bottom_edge =  false;
        top_edge = false;
        if (node_x2 >= submesh_bottom_node && node_x2 <= submesh_top_node){
            local_x2_node = node_x2 - submesh_bottom_node;
            if (local_x2_node == 0){
                bottom_edge = true;
                kcell_x2 = node_x2;
            }
            else if (local_x2_node == ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->submesh_Nel){
                top_edge = true;
                kcell_x2 = node_x2-1;
            }
            else{
                kcell_x2 = node_x2-1;
            }
            break;
        }
    }

    int isubmesh_x1 = isubmesh;
    int inp_x1 = local_x1_node;
    int isubmesh_x2 = jsubmesh;
    int inp_x2 = local_x2_node;

    if (pumi_mesh->isactive[isubmesh][jsubmesh]){
        *is_active_node = true;
        pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh, jsubmesh, kcell_x1, kcell_x2, &node1, &node3);
        if (inp_x1==0 && inp_x2==0){
            *nodeID = node1;
            return;
        }
        else if (inp_x1==0 && inp_x2!=0){
            *nodeID = node3;
            return;
        }
        else if (inp_x1!=0 && inp_x2==0){
            *nodeID = node1+1;
            return;
        }
        else{
            *nodeID = node3+1;
            return;
        }
    }
    else{
        if (!left_edge && !right_edge && !bottom_edge && !top_edge){
            *is_active_node = false;
            *nodeID = -1;
            return;
        }
        else{
            if (left_edge & !top_edge & !bottom_edge){
                if (isubmesh==0){
                    *is_active_node = false;
                    *nodeID = -1;
                    return;
                }
                else{
                    if (pumi_mesh->isactive[isubmesh-1][jsubmesh]){
                        *is_active_node = true;
                        pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh-1, jsubmesh, kcell_x1-1, kcell_x2, &node1, &node3);
                        *nodeID = node3+1;
                        return;
                    }
                    else{
                        *is_active_node = false;
                        *nodeID = -1;
                        return;
                    }
                }
            }

            if (left_edge & top_edge){
                if (jsubmesh==pumi_mesh->nsubmeshes_x2-1){
                    if (isubmesh==0){
                        *is_active_node = false;
                        *nodeID = -1;
                        return;
                    }
                    else{
                        if(pumi_mesh->isactive[isubmesh-1][jsubmesh]){
                            *is_active_node = true;
                            pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh-1, jsubmesh, kcell_x1-1, kcell_x2, &node1, &node3);
                            *nodeID = node3+1;
                            return;
                        }
                        else{
                            *is_active_node = false;
                            *nodeID = -1;
                            return;
                        }
                    }
                }
                else{
                    if (isubmesh==0){
                        if(pumi_mesh->isactive[isubmesh][jsubmesh+1]){
                            *is_active_node = true;
                            pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh, jsubmesh+1, kcell_x1, kcell_x2+1, &node1, &node3);
                            *nodeID = node1;
                            return;
                        }
                        else{
                            *is_active_node = false;
                            *nodeID = -1;
                            return;
                        }
                    }
                    else{
                        if (pumi_mesh->isactive[isubmesh-1][jsubmesh]){
                            *is_active_node  = true;
                            pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh-1, jsubmesh, kcell_x1-1, kcell_x2, &node1, &node3);
                            *nodeID = node3+1;
                            return;
                        }
                        else if (pumi_mesh->isactive[isubmesh-1][jsubmesh+1]){
                            *is_active_node = true;
                            pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh-1, jsubmesh+1, kcell_x1-1, kcell_x2+1, &node1, &node3);
                            *nodeID = node1+1;
                            return;
                        }
                        else if (pumi_mesh->isactive[isubmesh][jsubmesh+1]){
                            *is_active_node = true;
                            pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh, jsubmesh+1, kcell_x1, kcell_x2+1, &node1, &node3);
                            *nodeID = node1;
                            return;
                        }
                        else{
                            *is_active_node = false;
                            *nodeID = -1;
                            return;
                        }
                    }
                }
            }

            if (top_edge & !left_edge & !right_edge){
                if (jsubmesh==pumi_mesh->nsubmeshes_x2-1){
                    *is_active_node = false;
                    *nodeID = -1;
                    return;
                }
                else{
                    if (pumi_mesh->isactive[isubmesh][jsubmesh+1]){
                        *is_active_node = true;
                        pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh, jsubmesh+1, kcell_x1, kcell_x2+1, &node1, &node3);
                        *nodeID = node1+1;
                        return;
                    }
                    else{
                        *is_active_node = false;
                        *nodeID = -1;
                        return;
                    }
                }
            }

            if (top_edge & right_edge){
                if (jsubmesh==pumi_mesh->nsubmeshes_x2-1){
                    if (isubmesh==pumi_mesh->nsubmeshes_x1-1){
                        *is_active_node = false;
                        *nodeID = -1;
                        return;
                    }
                    else{
                        if(pumi_mesh->isactive[isubmesh+1][jsubmesh]){
                            *is_active_node = true;
                            pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh+1, jsubmesh, kcell_x1+1, kcell_x2, &node1, &node3);
                            *nodeID = node3;
                            return;
                        }
                        else{
                            *is_active_node = false;
                            *nodeID = -1;
                            return;
                        }
                    }
                }
                else{
                    if (isubmesh==pumi_mesh->nsubmeshes_x1-1){
                        if(pumi_mesh->isactive[isubmesh][jsubmesh+1]){
                            *is_active_node = true;
                            pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh, jsubmesh+1, kcell_x1, kcell_x2+1, &node1, &node3);
                            *nodeID = node1+1;
                            return;
                        }
                        else{
                            *is_active_node = false;
                            *nodeID = -1;
                            return;
                        }
                    }
                    else{
                        if (pumi_mesh->isactive[isubmesh+1][jsubmesh]){
                            *is_active_node = true;
                            pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh+1, jsubmesh, kcell_x1+1, kcell_x2, &node1, &node3);
                            *nodeID = node3;
                            return;
                        }
                        else if (pumi_mesh->isactive[isubmesh+1][jsubmesh+1]){
                            *is_active_node = true;
                            pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh+1, jsubmesh+1, kcell_x1+1, kcell_x2+1, &node1, &node3);
                            *nodeID = node1;
                            return;
                        }
                        else if (pumi_mesh->isactive[isubmesh][jsubmesh+1]){
                            *is_active_node = true;
                            pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh, jsubmesh+1, kcell_x1, kcell_x2+1, &node1, &node3);
                            *nodeID = node1+1;
                            return;
                        }
                        else{
                            *is_active_node = false;
                            *nodeID = -1;
                            return;
                        }
                    }
                }
            }

            if (right_edge & !top_edge & !bottom_edge){
                if (isubmesh==pumi_mesh->nsubmeshes_x1-1){
                    *is_active_node = false;
                    *nodeID = -1;
                    return;
                }
                else{
                    if (pumi_mesh->isactive[isubmesh+1][jsubmesh]){
                        *is_active_node = true;
                        pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh+1, jsubmesh, kcell_x1+1, kcell_x2, &node1, &node3);
                        *nodeID = node3;
                        return;
                    }
                    else{
                        *is_active_node = false;
                        *nodeID = -1;
                        return;
                    }
                }
            }

            if (right_edge & bottom_edge){
                if (jsubmesh==0){
                    if (isubmesh==pumi_mesh->nsubmeshes_x1-1){
                        *is_active_node = false;
                        *nodeID = -1;
                        return;
                    }
                    else{
                        if(pumi_mesh->isactive[isubmesh+1][jsubmesh]){
                            *is_active_node = true;
                            pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh+1, jsubmesh, kcell_x1+1, kcell_x2, &node1, &node3);
                            *nodeID = node1;
                            return;
                        }
                        else{
                            *is_active_node = false;
                            *nodeID = -1;
                            return;
                        }
                    }
                }
                else{
                    if (isubmesh==pumi_mesh->nsubmeshes_x1-1){
                        if(pumi_mesh->isactive[isubmesh][jsubmesh-1]){
                            *is_active_node = true;
                            pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh, jsubmesh-1, kcell_x1, kcell_x2-1, &node1, &node3);
                            *nodeID = node3+1;
                            return;
                        }
                        else{
                            *is_active_node = false;
                            *nodeID = -1;
                            return;
                        }
                    }
                    else{
                        if (pumi_mesh->isactive[isubmesh+1][jsubmesh]){
                            *is_active_node = true;
                            pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh+1, jsubmesh, kcell_x1+1, kcell_x2, &node1, &node3);
                            *nodeID = node1;
                            return;
                        }
                        else if (pumi_mesh->isactive[isubmesh+1][jsubmesh-1]){
                            *is_active_node = true;
                            pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh+1, jsubmesh-1, kcell_x1+1, kcell_x2-1, &node1, &node3);
                            *nodeID = node3;
                            return;
                        }
                        else if (pumi_mesh->isactive[isubmesh][jsubmesh-1]){
                            *is_active_node = true;
                            pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh, jsubmesh-1, kcell_x1, kcell_x2-1, &node1, &node3);
                            *nodeID = node3+1;
                            return;
                        }
                        else{
                            *is_active_node = false;
                            *nodeID = -1;
                            return;
                        }
                    }
                }
            }

            if (bottom_edge & !left_edge &!right_edge){
                if (jsubmesh==0){
                    *is_active_node = false;
                    *nodeID = -1;
                    return;
                }
                else{
                    if (pumi_mesh->isactive[isubmesh][jsubmesh-1]){
                        *is_active_node = true;
                        pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh, jsubmesh-1, kcell_x1, kcell_x2-1, &node1, &node3);
                        *nodeID = node3+1;
                        return;
                    }
                    else{
                        *is_active_node = false;
                        *nodeID = -1;
                        return;
                    }
                }
            }

            if (bottom_edge & left_edge){
                if (jsubmesh==0){
                    if (isubmesh==0){
                        *is_active_node = false;
                        *nodeID = -1;
                        return;
                    }
                    else{
                        if(pumi_mesh->isactive[isubmesh-1][jsubmesh]){
                            *is_active_node = true;
                            pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh-1, jsubmesh, kcell_x1-1, kcell_x2, &node1, &node3);
                            *nodeID = node1+1;
                            return;
                        }
                        else{
                            *is_active_node = false;
                            *nodeID = -1;
                            return;
                        }
                    }
                }
                else{
                    if (isubmesh==0){
                        if(pumi_mesh->isactive[isubmesh][jsubmesh-1]){
                            *is_active_node = true;
                            pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh, jsubmesh-1, kcell_x1, kcell_x2-1, &node1, &node3);
                            *nodeID = node3;
                            return;
                        }
                        else{
                            *is_active_node = false;
                            *nodeID = -1;
                            return;
                        }
                    }
                    else{
                        if (pumi_mesh->isactive[isubmesh-1][jsubmesh]){
                            *is_active_node = true;
                            pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh-1, jsubmesh, kcell_x1-1, kcell_x2, &node1, &node3);
                            *nodeID = node1+1;
                            return;
                        }
                        else if (pumi_mesh->isactive[isubmesh-1][jsubmesh-1]){
                            *is_active_node = true;
                            pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh-1, jsubmesh-1, kcell_x1-1, kcell_x2-1, &node1, &node3);
                            *nodeID = node3+1;
                            return;
                        }
                        else if (pumi_mesh->isactive[isubmesh][jsubmesh-1]){
                            *is_active_node = true;
                            pumi_calc_elementID_and_nodeID(pumi_mesh, isubmesh, jsubmesh-1, kcell_x1, kcell_x2-1, &node1, &node3);
                            *nodeID = node3;
                            return;
                        }
                        else{
                            *is_active_node = false;
                            *nodeID = -1;
                            return;
                        }
                    }
                }
            }
        }
    }

}

bool pumi_is_node_on_bdry(pumi_mesh_t *pumi_mesh, int node_x1, int node_x2){
    if (pumi_is_fullmesh(pumi_mesh)){
        if (node_x1==0 || node_x1==pumi_mesh->pumi_Nel_total_x1 || node_x2==0 || node_x2==pumi_mesh->pumi_Nel_total_x2){
            return true;
        }
        else{
            return false;
        }
    }
    else{
        if (node_x1==0 || node_x1==pumi_mesh->pumi_Nel_total_x1 || node_x2==0 || node_x2==pumi_mesh->pumi_Nel_total_x2){
            return true;
        }
        else{
            int isubmesh, jsubmesh, local_x1_node, local_x2_node;
            bool left_edge, right_edge, bottom_edge, top_edge;
            for (isubmesh=0; isubmesh<pumi_mesh->nsubmeshes_x1; isubmesh++){

                int submesh_left_node = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->Nel_cumulative;
                int submesh_right_node = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->Nel_cumulative + ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->submesh_Nel;
                left_edge =  false;
                right_edge = false;
                if (node_x1 >= submesh_left_node && node_x1 <= submesh_right_node){
                    local_x1_node = node_x1 - submesh_left_node;
                    if (local_x1_node == 0){
                        left_edge = true;
                    }
                    if (local_x1_node == ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x1 + isubmesh)->submesh_Nel){
                        right_edge = true;
                    }
                    break;
                }
            }

            for (jsubmesh=0; jsubmesh<pumi_mesh->nsubmeshes_x2; jsubmesh++){

                int submesh_bottom_node = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->Nel_cumulative;
                int submesh_top_node = ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->Nel_cumulative + ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->submesh_Nel;
                bottom_edge =  false;
                top_edge = false;
                if (node_x2 >= submesh_bottom_node && node_x2 <= submesh_top_node){
                    local_x2_node = node_x2 - submesh_bottom_node;
                    if (local_x2_node == 0){
                        bottom_edge = true;
                    }
                    if (local_x2_node == ((pumi_submesh_t*) pumi_mesh->pumi_submeshes_x2 + jsubmesh)->submesh_Nel){
                        top_edge = true;
                    }
                    break;
                }
            }

            if (!left_edge && !right_edge && !bottom_edge && !top_edge){
                return false;
            }

            if (left_edge & !top_edge & !bottom_edge){
                if ( pumi_mesh->isactive[isubmesh][jsubmesh] + pumi_mesh->isactive[isubmesh-1][jsubmesh] == 1 ){
                    return true;
                }
                else{
                    return false;
                }
            }

            if (left_edge & top_edge){
                int sum = pumi_mesh->isactive[isubmesh][jsubmesh] + pumi_mesh->isactive[isubmesh-1][jsubmesh] +
                pumi_mesh->isactive[isubmesh-1][jsubmesh+1] + pumi_mesh->isactive[isubmesh][jsubmesh+1];
                if ( sum > 0 && sum < 4 ){
                    return true;
                }
                else{
                    return false;
                }
            }

            if (top_edge & !left_edge & !right_edge){
                if ( pumi_mesh->isactive[isubmesh][jsubmesh] + pumi_mesh->isactive[isubmesh][jsubmesh+1] == 1 ){
                    return true;
                }
                else{
                    return false;
                }
            }

            if (top_edge & right_edge){
                int sum = pumi_mesh->isactive[isubmesh][jsubmesh] + pumi_mesh->isactive[isubmesh+1][jsubmesh] +
                pumi_mesh->isactive[isubmesh][jsubmesh+1] + pumi_mesh->isactive[isubmesh+1][jsubmesh+1];
                if ( sum > 0 && sum < 4 ){
                    return true;
                }
                else{
                    return false;
                }
            }

            if (right_edge & !top_edge & !bottom_edge){
                if ( pumi_mesh->isactive[isubmesh][jsubmesh] + pumi_mesh->isactive[isubmesh+1][jsubmesh] == 1 ){
                    return true;
                }
                else{
                    return false;
                }
            }

            if (right_edge & bottom_edge){
                int sum = pumi_mesh->isactive[isubmesh][jsubmesh] + pumi_mesh->isactive[isubmesh+1][jsubmesh] +
                pumi_mesh->isactive[isubmesh+1][jsubmesh-1] + pumi_mesh->isactive[isubmesh][jsubmesh-1];
                if ( sum > 0 && sum < 4 ){
                    return true;
                }
                else{
                    return false;
                }
            }

            if (bottom_edge & !left_edge &!right_edge){
                if ( pumi_mesh->isactive[isubmesh][jsubmesh] + pumi_mesh->isactive[isubmesh][jsubmesh-1] == 1 ){
                    return true;
                }
                else{
                    return false;
                }
            }

            if (bottom_edge & right_edge){
                int sum = pumi_mesh->isactive[isubmesh][jsubmesh] + pumi_mesh->isactive[isubmesh-1][jsubmesh] +
                pumi_mesh->isactive[isubmesh-1][jsubmesh-1] + pumi_mesh->isactive[isubmesh][jsubmesh-1];
                if ( sum > 0 && sum < 4 ){
                    return true;
                }
                else{
                    return false;
                }
            }

        }
    }
}

void pumi_initialize_nodeID_functions(pumi_mesh_t *pumi_mesh){
    pumi_nodeID_fnptr = (pumi_nodeID_ptr**) malloc(pumi_mesh->nsubmeshes_x1 * sizeof(pumi_nodeID_ptr *));
    int isubmesh, jsubmesh;
    for (isubmesh=0; isubmesh<pumi_mesh->nsubmeshes_x1; isubmesh++){
        pumi_nodeID_fnptr[isubmesh] = (pumi_nodeID_ptr*) malloc(pumi_mesh->nsubmeshes_x2 * sizeof(pumi_nodeID_ptr));
    }

    if (pumi_is_fullmesh(pumi_mesh)){
        printf("No INACTIVE blocks in mesh detected -- Intializing element/node ID routines without offsets\n\n");
        for (jsubmesh=0; jsubmesh<pumi_mesh->nsubmeshes_x2; jsubmesh++){
            for (isubmesh=0; isubmesh<pumi_mesh->nsubmeshes_x1; isubmesh++){
                pumi_nodeID_fnptr[isubmesh][jsubmesh] = pumi_calc_elementID_and_nodeID_on_fullmesh;
            }
        }
    }
    else{
        printf("INACTIVE blocks in mesh detected -- Intializing element/node ID routines with offsets\n\n");
        for (jsubmesh=0; jsubmesh<pumi_mesh->nsubmeshes_x2; jsubmesh++){
            for (isubmesh=0; isubmesh<pumi_mesh->nsubmeshes_x1; isubmesh++){
                if (pumi_mesh->isactive[isubmesh][jsubmesh]){
                    if (pumi_mesh->nodeoffset_cache_flag){
                        pumi_nodeID_fnptr[isubmesh][jsubmesh] = pumi_calc_elementID_and_nodeID_with_global_offset;
                    }
                    else{
                        if (pumi_mesh->blocktype[isubmesh][jsubmesh] == type_A){
                            pumi_nodeID_fnptr[isubmesh][jsubmesh] = &pumi_calc_elementID_and_nodeID_typeA;
                        }
                        else if (pumi_mesh->blocktype[isubmesh][jsubmesh] == type_B){
                            pumi_nodeID_fnptr[isubmesh][jsubmesh] = &pumi_calc_elementID_and_nodeID_typeB;
                        }
                        else if (pumi_mesh->blocktype[isubmesh][jsubmesh] == type_C){
                            pumi_nodeID_fnptr[isubmesh][jsubmesh] = &pumi_calc_elementID_and_nodeID_typeC;
                        }
                        else if (pumi_mesh->blocktype[isubmesh][jsubmesh] == type_D){
                            pumi_nodeID_fnptr[isubmesh][jsubmesh] = &pumi_calc_elementID_and_nodeID_typeD;
                        }
                    }
                }
            }
        }

        pumi_typeB_nodeoffset_fnptr[0] = &pumi_typeB_nodeoffset_expression1;
        pumi_typeB_nodeoffset_fnptr[1] = &pumi_typeB_nodeoffset_expression2;

        pumi_typeC_nodeoffset_fnptr[0] = &pumi_typeC_nodeoffset_expression1;
        pumi_typeC_nodeoffset_fnptr[1] = &pumi_typeC_nodeoffset_expression2;

        pumi_typeD_nodeoffset_fnptr[0] = &pumi_typeD_nodeoffset_expression1;
        pumi_typeD_nodeoffset_fnptr[1] = &pumi_typeD_nodeoffset_expression2;
        pumi_typeD_nodeoffset_fnptr[2] = &pumi_typeD_nodeoffset_expression3;
    }


}

void pumi_finalize_nodeID_functions(pumi_mesh_t *pumi_mesh){
    int isubmesh;
    for (isubmesh=0; isubmesh<pumi_mesh->nsubmeshes_x1; isubmesh++){
        free(pumi_nodeID_fnptr[isubmesh]);
    }
    free(pumi_nodeID_fnptr);
}

void pumi_reset_Qspl_coeffs(pumi_mesh_t* pumi_mesh){
    int i;
    for (i=0; i<pumi_mesh->pumi_bspl.N_spline; i++){
        pumi_mesh->pumi_bspl.Q_coeffs[i] = 0.0;
    }
}

void pumi_compute_Qspl_coeffs(pumi_mesh_t* pumi_mesh, double xi, int iel, double Q_macro_particle, bool* left_bdry_flux, bool* right_bdry_flux, double *bdry_flux_val){
    int i,j;
    double one_minus_xi = 1.0-xi;
    double xi_term = 1.0;
    double one_minus_xi_term = pow(one_minus_xi,pumi_mesh->P_spline);
    for (i=0; i<pumi_mesh->P_spline+1; i++){
        pumi_mesh->pumi_bspl.bernstein_vector[i] = pumi_mesh->pumi_bspl.nCk4spline[i]*xi_term*one_minus_xi_term;
        xi_term *= xi;
        one_minus_xi_term /= one_minus_xi;
    }
    double spl_contribution[100];
    for (i=0; i<pumi_mesh->P_spline+1; i++){
        spl_contribution[i] = 0.0;
        for (j=0; j<pumi_mesh->P_spline+1; j++){
            // pumi_mesh->pumi_bspl.Q_coeffs[pumi_mesh->P_spline+iel+i] += Q_macro_particle*pumi_mesh->pumi_bspl.pumi_bez_ex_x1[pumi_mesh->P_spline+iel].C[i][j]*pumi_mesh->pumi_bspl.bernstein_vector[j];
            spl_contribution[i] += pumi_mesh->pumi_bspl.pumi_bez_ex_x1[pumi_mesh->P_spline+iel].C[i][j]*pumi_mesh->pumi_bspl.bernstein_vector[j];;
        }
        pumi_mesh->pumi_bspl.Q_coeffs[pumi_mesh->P_spline+iel+i] += Q_macro_particle*spl_contribution[i];
    }
    *bdry_flux_val = 0.0;
    *left_bdry_flux = false;
    *right_bdry_flux = false;
    if (iel <= pumi_mesh->P_spline){
        *left_bdry_flux = true;
        for (i=iel; i<pumi_mesh->P_spline+1; i++){
            *bdry_flux_val += pumi_mesh->pumi_bspl.pumi_bez_ex_x1[pumi_mesh->P_spline].C[i][0]*spl_contribution[i-iel];
        }
        return;
    }
    if (iel >= pumi_mesh->pumi_Nel_total_x1-pumi_mesh->P_spline-1){
        *right_bdry_flux = true;
        int iel_new = pumi_mesh->pumi_Nel_total_x1-1-iel;
        for (i=iel_new; i<pumi_mesh->P_spline+1; i++){
            *bdry_flux_val += pumi_mesh->pumi_bspl.pumi_bez_ex_x1[pumi_mesh->P_spline+pumi_mesh->pumi_Nel_total_x1-1].C[i-iel_new][pumi_mesh->P_spline]*spl_contribution[i];
        }
        return;
    }
    return;
}

void pumi_compute_covspl_coeffs(pumi_mesh_t* pumi_mesh, int dir){
    int nel = pumi_mesh->pumi_Nel_total_x1;
    int nq = floor((pumi_mesh->P_spline+1.0)/2.0)+1;

    double *N1 = (double*) malloc(nq * sizeof(double));
    double *N2 = (double*) malloc(nq * sizeof(double));
    double dN1 = -0.5;
    double dN2 = 0.5;
    int iq, iel;
    for (iq=0; iq<nq; iq++){
        N1[iq] = 0.5*(1.0-gauss_pts[nq-1][iq]);
        N2[iq] = 0.5*(1.0+gauss_pts[nq-1][iq]);
    }
    double node1, node2;
    double xl[2];
    double dxdxi, xi, WdetJ, xglobal;
    node1 = pumi_global_x1_min(pumi_mesh);
    int ispline;
    for (ispline=0; ispline<pumi_mesh->pumi_bspl.N_spline; ispline++){
        pumi_mesh->pumi_bspl.cov_coeffs[ispline] = 0.0;
    }

    for (iel=0; iel<nel; iel++){
        node2 = node1 + pumi_return_elemsize(pumi_mesh, iel, pumi_elem_input_offset, dir);
        xl[0] = node1;
        xl[1] = node2;
        node1 = node2;

        for (iq=0; iq<nq; iq++){
            double Nq[2] = {N1[iq], N2[iq]};
            double dNq[2] = {dN1, dN2};
            dxdxi = dNq[0]*xl[0]+dNq[1]*xl[1];
            xglobal = Nq[0]*xl[0]+Nq[1]*xl[1];
            WdetJ = gauss_wts[nq-1][iq]*dxdxi;
            xi = (xglobal-xl[0])/(xl[1]-xl[0]);

            int i,j;
            double one_minus_xi = 1.0-xi;
            double xi_term = 1.0;
            double one_minus_xi_term = pow(one_minus_xi,pumi_mesh->P_spline);
            for (i=0; i<pumi_mesh->P_spline+1; i++){
                pumi_mesh->pumi_bspl.bernstein_vector[i] = pumi_mesh->pumi_bspl.nCk4spline[i]*xi_term*one_minus_xi_term;
                xi_term *= xi;
                one_minus_xi_term /= one_minus_xi;
            }

            for (i=0; i<pumi_mesh->P_spline+1; i++){
                for (j=0; j<pumi_mesh->P_spline+1; j++){
                    pumi_mesh->pumi_bspl.cov_coeffs[pumi_mesh->P_spline+iel+i] += WdetJ*pumi_mesh->pumi_bspl.pumi_bez_ex_x1[pumi_mesh->P_spline+iel].C[i][j]*pumi_mesh->pumi_bspl.bernstein_vector[j];
                }
            }
        }
    }

    free(N1);
    free(N2);
}

void pumi_compute_bspline_nodal_density(pumi_mesh_t* pumi_mesh, int dir, double* charge_density){
    int nel = pumi_mesh->pumi_Nel_total_x1;
    int nq = floor((pumi_mesh->P_spline+1.0)/2.0)+1;

    double *N1 = (double*) malloc(nq * sizeof(double));
    double *N2 = (double*) malloc(nq * sizeof(double));
    double dN1 = -0.5;
    double dN2 = 0.5;
    int iq, iel;
    for (iq=0; iq<nq; iq++){
        N1[iq] = 0.5*(1.0-gauss_pts[nq-1][iq]);
        N2[iq] = 0.5*(1.0+gauss_pts[nq-1][iq]);
    }
    double node1, node2;
    double xl[2];
    double dxdxi, xi, WdetJ, xglobal;
    node1 = pumi_global_x1_min(pumi_mesh);
    int i,j,ishl,jshl;
    double **A;
    A = (double**) malloc((nel+1)*sizeof(double*));
    for (i=0; i<nel+1; i++){
        A[i] = (double*) malloc((nel+1)*sizeof(double));
    }
    double *b = (double*) malloc((nel+1)*sizeof(double));
    double Ni_q, Q_q, cov_q;
    for (i=0; i<nel+1; i++){
        b[i] = 0.0;
        for (j=0; j<nel+1; j++){
            A[i][j] = 0.0;
        }
    }

    for (iel=0; iel<nel; iel++){
        double Ae[2][2] = { {0.0, 0.0}, {0.0, 0.0}};
        double be[2] = {0.0, 0.0};
        node2 = node1 + pumi_return_elemsize(pumi_mesh, iel, pumi_elem_input_offset, dir);
        xl[0] = node1;
        xl[1] = node2;
        node1 = node2;
        int ien[2] = {iel, iel+1};

        for (iq=0; iq<nq; iq++){
            double Nq[2] = {N1[iq], N2[iq]};
            double dNq[2] = {dN1, dN2};
            dxdxi = dNq[0]*xl[0]+dNq[1]*xl[1];
            xglobal = Nq[0]*xl[0]+Nq[1]*xl[1];
            WdetJ = gauss_wts[nq-1][iq]*dxdxi;
            xi = (xglobal-xl[0])/(xl[1]-xl[0]);

            int i,j;
            double one_minus_xi = 1.0-xi;
            double xi_term = 1.0;
            double one_minus_xi_term = pow(one_minus_xi,pumi_mesh->P_spline);
            for (i=0; i<pumi_mesh->P_spline+1; i++){
                pumi_mesh->pumi_bspl.bernstein_vector[i] = pumi_mesh->pumi_bspl.nCk4spline[i]*xi_term*one_minus_xi_term;
                xi_term *= xi;
                one_minus_xi_term /= one_minus_xi;
            }
            cov_q=0.0;
            Q_q=0.0;
            for (i=0; i<pumi_mesh->P_spline+1; i++){
                Ni_q = 0.0;
                for (j=0; j<pumi_mesh->P_spline+1; j++){
                    Ni_q += pumi_mesh->pumi_bspl.pumi_bez_ex_x1[pumi_mesh->P_spline+iel].C[i][j]*pumi_mesh->pumi_bspl.bernstein_vector[j];
                }
                cov_q += Ni_q*pumi_mesh->pumi_bspl.cov_coeffs[pumi_mesh->P_spline+iel+i];
                Q_q += Ni_q*pumi_mesh->pumi_bspl.Q_coeffs[pumi_mesh->P_spline+iel+i];
            }

            for (ishl=0; ishl<2; ishl++){
                be[ishl] += Nq[ishl]*WdetJ*Q_q/cov_q;
                for (jshl=0; jshl<2; jshl++){
                    Ae[ishl][jshl] += Nq[ishl]*Nq[jshl]*WdetJ;
                }
            }
        }

        for (ishl=0; ishl<2; ishl++){
            b[ien[ishl]] += be[ishl];
            for (jshl=0; jshl<2; jshl++){
                A[ien[ishl]][ien[jshl]] += Ae[ishl][jshl];
            }
        }

    }

    for (i=0; i<nel+1; i++){
        double Arowsum=0.0;
        for (j=0; j<nel+1; j++){
            Arowsum += A[i][j];
        }
        charge_density[i] = b[i]/Arowsum;
    }

    for (i=0; i<nel+1; i++){
        free(A[i]);
    }
    free(A);
    free(b);
    free(N1);
    free(N2);
}

void pumi_reset_Espl_coeffs(pumi_mesh_t* pumi_mesh){
    int i;
    for (i=0; i<pumi_mesh->pumi_bspl.N_spline; i++){
        pumi_mesh->pumi_bspl.E_coeffs[i] = 0.0;
    }
}

void pumi_compute_Espl_coeffs(pumi_mesh_t *pumi_mesh, double *E_dir, int dir){
    int nel = pumi_mesh->pumi_Nel_total_x1;
    int nq = floor((2*pumi_mesh->P_spline+1.0)/2.0)+1;
    int Nspline = pumi_mesh->pumi_bspl.N_spline;
    double *N1 = (double*) malloc(nq * sizeof(double));
    double *N2 = (double*) malloc(nq * sizeof(double));
    double *elem_splines = (double*) malloc((pumi_mesh->P_spline+1)*sizeof(double));
    double dN1 = -0.5;
    double dN2 = 0.5;
    int iq, iel;
    for (iq=0; iq<nq; iq++){
        N1[iq] = 0.5*(1.0-gauss_pts[nq-1][iq]);
        N2[iq] = 0.5*(1.0+gauss_pts[nq-1][iq]);
    }
    double node1, node2;
    double xl[2];
    double dxdxi, xi, WdetJ, xglobal, Eq;
    node1 = pumi_global_x1_min(pumi_mesh);
    int i,j,ishl,jshl;
    double **A;
    A = (double**) malloc(Nspline*sizeof(double*));
    for (i=0; i<Nspline; i++){
        A[i] = (double*) malloc(Nspline*sizeof(double));
    }
    double *b = (double*) malloc(Nspline*sizeof(double));
    for (i=0; i<Nspline; i++){
        b[i] = 0.0;
        for (j=0; j<Nspline; j++){
            A[i][j] = 0.0;
        }
    }

    for (iel=0; iel<nel; iel++){
        node2 = node1 + pumi_return_elemsize(pumi_mesh, iel, pumi_elem_input_offset, dir);
        xl[0] = node1;
        xl[1] = node2;
        node1 = node2;
        double E_e[2] = {E_dir[iel], E_dir[iel+1]};

        for (iq=0; iq<nq; iq++){
            double Nq[2] = {N1[iq], N2[iq]};
            double dNq[2] = {dN1, dN2};
            dxdxi = dNq[0]*xl[0]+dNq[1]*xl[1];
            xglobal = Nq[0]*xl[0]+Nq[1]*xl[1];
            Eq = Nq[0]*E_e[0]+Nq[1]*E_e[1];
            WdetJ = gauss_wts[nq-1][iq]*dxdxi;
            xi = (xglobal-xl[0])/(xl[1]-xl[0]);

            int i,j;
            double one_minus_xi = 1.0-xi;
            double xi_term = 1.0;
            double one_minus_xi_term = pow(one_minus_xi,pumi_mesh->P_spline);
            for (i=0; i<pumi_mesh->P_spline+1; i++){
                pumi_mesh->pumi_bspl.bernstein_vector[i] = pumi_mesh->pumi_bspl.nCk4spline[i]*xi_term*one_minus_xi_term;
                xi_term *= xi;
                one_minus_xi_term /= one_minus_xi;
            }
            for (i=0; i<pumi_mesh->P_spline+1; i++){
                elem_splines[i] = 0.0;
                for (j=0; j<pumi_mesh->P_spline+1; j++){
                    elem_splines[i] += pumi_mesh->pumi_bspl.pumi_bez_ex_x1[pumi_mesh->P_spline+iel].C[i][j]*pumi_mesh->pumi_bspl.bernstein_vector[j];
                }
            }

            for (i=0; i<pumi_mesh->P_spline+1; i++){
                b[i+pumi_mesh->P_spline+iel] += Eq*elem_splines[i]*WdetJ;
                for (j=0; j<pumi_mesh->P_spline+1; j++){
                    A[i+pumi_mesh->P_spline+iel][j+pumi_mesh->P_spline+iel] += elem_splines[i]*elem_splines[j]*WdetJ;
                }
            }

        }
    }

    for (i=pumi_mesh->P_spline; i<2*pumi_mesh->P_spline+nel; i++){
        double Arowsum=0.0;
        for (j=pumi_mesh->P_spline; j<2*pumi_mesh->P_spline+nel; j++){
            Arowsum += A[i][j];
        }
        pumi_mesh->pumi_bspl.E_coeffs[i] = b[i]/Arowsum;
    }

    for (i=0; i<Nspline; i++){
        free(A[i]);
    }
    free(A);
    free(b);
    free(elem_splines);
    free(N1);
    free(N2);
}

double pumi_compute_Espl_value(pumi_mesh_t* pumi_mesh, double xi, int iel){
    int i,j;
    double one_minus_xi = 1.0-xi;
    double xi_term = 1.0;
    double one_minus_xi_term = pow(one_minus_xi,pumi_mesh->P_spline);
    for (i=0; i<pumi_mesh->P_spline+1; i++){
        pumi_mesh->pumi_bspl.bernstein_vector[i] = pumi_mesh->pumi_bspl.nCk4spline[i]*xi_term*one_minus_xi_term;
        xi_term *= xi;
        one_minus_xi_term /= one_minus_xi;
    }
    double spl_contribution;
    double Ex=0.0;
    for (i=0; i<pumi_mesh->P_spline+1; i++){
        spl_contribution = 0.0;
        for (j=0; j<pumi_mesh->P_spline+1; j++){
            spl_contribution += pumi_mesh->pumi_bspl.pumi_bez_ex_x1[pumi_mesh->P_spline+iel].C[i][j]*pumi_mesh->pumi_bspl.bernstein_vector[j];;
        }
        Ex += pumi_mesh->pumi_bspl.E_coeffs[pumi_mesh->P_spline+iel+i]*spl_contribution;
    }
    return Ex;
}
